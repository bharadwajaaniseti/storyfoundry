'use client'

import React, { useState, useEffect, useRef, useCallback } from 'react'
import { 
  Plus, Heart, Search, MoreVertical, Trash2, Edit3, Users, 
  ArrowRight, Eye, EyeOff, Filter, X, ChevronDown, ChevronRight,
  Link2, Target, Zap, Crown, Shield, MessageCircle, Flame,
  Save, User, AlertTriangle, CheckCircle, Clock, Calendar,
  GitBranch, Network, BarChart3, TrendingUp, Activity, Grid,
  Layers, Move, RotateCcw, Share2, Download, Upload, Settings,
  Home, Swords, BookOpen, UserCircle, Palette, ZoomIn, ZoomOut,
  Type
} from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Textarea } from '@/components/ui/textarea'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { createSupabaseClient } from '@/lib/auth'
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Label } from '@/components/ui/label'
import { Badge } from '@/components/ui/badge'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { Progress } from '@/components/ui/progress'
import { Separator } from '@/components/ui/separator'
import { cn } from '@/lib/utils'

// Enhanced Custom Components matching site design
interface EnhancedSelectProps {
  value?: string
  onValueChange?: (value: string) => void
  placeholder?: string
  children: React.ReactNode
  className?: string
  triggerClassName?: string
  contentClassName?: string
  customDisplay?: string
  onOpenChange?: (open: boolean) => void
  [key: string]: any
}

const EnhancedSelect = ({ 
  value, 
  onValueChange, 
  placeholder, 
  children, 
  className,
  triggerClassName,
  contentClassName,
  customDisplay,
  ...props 
}: EnhancedSelectProps) => {
  const [isOpen, setIsOpen] = React.useState(false)
  
  return (
    <Select 
      value={value} 
      onValueChange={onValueChange} 
      onOpenChange={setIsOpen}
      {...props}
    >
      <SelectTrigger 
        className={cn(
          "relative bg-white border-2 border-gray-200 rounded-xl shadow-sm px-5 py-4",
          "hover:border-rose-300 focus:border-rose-500 focus:ring-2 focus:ring-rose-100",
          "transition-all duration-300 ease-out text-left overflow-hidden",
          "data-[state=open]:border-rose-500 data-[state=open]:ring-2 data-[state=open]:ring-rose-100",
          "data-[state=open]:shadow-lg",
          "[&>svg]:hidden", // Hide the default chevron
          triggerClassName,
          className
        )}
      >
        <div className="flex-1 pr-8 min-w-0 overflow-hidden">
          {customDisplay ? (
            <span className="text-base font-medium block truncate w-full text-left text-gray-900">
              {customDisplay}
            </span>
          ) : (
            <SelectValue 
              placeholder={placeholder} 
              className="text-base font-medium block truncate w-full text-left" 
            />
          )}
        </div>
        <ChevronDown 
          className={cn(
            "absolute right-5 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-500 flex-shrink-0",
            "transition-transform duration-200 pointer-events-none",
            isOpen && "rotate-180"
          )} 
        />
      </SelectTrigger>
      <SelectContent 
        className={cn(
          "bg-white border-2 border-gray-200 rounded-xl shadow-xl p-3 min-w-[300px]",
          "animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95",
          "data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2",
          "data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
          "backdrop-blur-sm max-h-[400px] overflow-y-auto",
          contentClassName
        )}
        sideOffset={6}
      >
        {children}
      </SelectContent>
    </Select>
  )
}

interface EnhancedSelectItemProps {
  children: React.ReactNode
  className?: string
  value: string
  [key: string]: any
}

const EnhancedSelectItem = ({ children, className, ...props }: EnhancedSelectItemProps) => {
  return (
    <SelectItem
      className={cn(
        "relative flex cursor-pointer select-none items-center rounded-xl px-5 py-4 mx-1 my-1.5",
        "text-base outline-none transition-all duration-200",
        "hover:bg-rose-50 hover:text-rose-900 focus:bg-rose-50 focus:text-rose-900",
        "data-[state=checked]:bg-rose-500 data-[state=checked]:text-white",
        "data-[state=checked]:shadow-md min-h-[56px]",
        className
      )}
      {...props}
    >
      <span className="absolute right-4 flex h-5 w-5 items-center justify-center">
        <CheckCircle className="h-4 w-4 opacity-0 data-[state=checked]:opacity-100 transition-opacity duration-200" />
      </span>
      <div className="flex-1 pr-8">
        {children}
      </div>
    </SelectItem>
  )
}

interface EnhancedInputProps extends React.InputHTMLAttributes<HTMLInputElement> {
  className?: string
}

const EnhancedInput = React.forwardRef<HTMLInputElement, EnhancedInputProps>(({ className, ...props }, ref) => {
  return (
    <Input
      ref={ref}
      className={cn(
        "bg-white border-2 border-gray-200 rounded-xl shadow-sm px-5 py-4 text-base",
        "hover:border-rose-300 focus:border-rose-500 focus:ring-2 focus:ring-rose-100",
        "transition-all duration-300 ease-out placeholder:text-gray-400",
        className
      )}
      {...props}
    />
  )
})

EnhancedInput.displayName = "EnhancedInput"

interface EnhancedTextareaProps extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {
  className?: string
}

const EnhancedTextarea = React.forwardRef<HTMLTextAreaElement, EnhancedTextareaProps>(({ className, ...props }, ref) => {
  return (
    <Textarea
      ref={ref}
      className={cn(
        "bg-white border-2 border-gray-200 rounded-xl shadow-sm px-5 py-4 text-base min-h-[120px]",
        "hover:border-rose-300 focus:border-rose-500 focus:ring-2 focus:ring-rose-100",
        "transition-all duration-300 ease-out placeholder:text-gray-400 resize-none",
        className
      )}
      {...props}
    />
  )
})

EnhancedTextarea.displayName = "EnhancedTextarea"

interface EnhancedSliderProps {
  value: number
  onChange: (e: React.ChangeEvent<HTMLInputElement>) => void
  min?: number
  max?: number
  label?: string
  color?: string
  className?: string
  leftLabel?: string
  rightLabel?: string
  [key: string]: any
}

const EnhancedSlider = ({ value, onChange, min = 0, max = 10, label, color = "rose", className, ...props }: EnhancedSliderProps) => {
  return (
    <div className="space-y-3">
      <Input
        type="range"
        min={min}
        max={max}
        value={value}
        onChange={onChange}
        className={cn(
          "w-full h-3 bg-gray-200 rounded-xl appearance-none cursor-pointer",
          "slider-thumb:appearance-none slider-thumb:w-6 slider-thumb:h-6",
          `slider-thumb:bg-${color}-500 slider-thumb:rounded-full slider-thumb:shadow-lg`,
          "slider-thumb:border-4 slider-thumb:border-white slider-thumb:cursor-pointer",
          "hover:bg-gray-300 transition-colors duration-200",
          className
        )}
        {...props}
      />
      <div className="flex justify-between text-sm text-gray-500">
        <span>{props.leftLabel || 'Low'}</span>
        <span className={`font-medium text-${color}-500`}>
          {label ? `${label}: ` : ''}{value}/{max}
        </span>
        <span>{props.rightLabel || 'High'}</span>
      </div>
    </div>
  )
}

interface Relationship {
  id: string
  name: string
  description: string
  attributes: {
    type?: string // romantic, familial, friendship, rivalry, professional, etc.
    strength?: number // 1-10 scale
    status?: string // active, former, complicated, unknown
    dynamics?: string[] // mutual_respect, one_sided, toxic, supportive, etc.
    history?: string
    current_state?: string
    character_1_id?: string
    character_1_name?: string
    character_2_id?: string
    character_2_name?: string
    notes?: string
    // Enhanced Campfire-style features
    timeline_events?: Array<{
      date: string
      event: string
      description: string
      impact_level: 'low' | 'medium' | 'high'
      relationship_change: number // -5 to +5
    }>
    tension_level?: number // 0-10 scale for conflict/tension
    intimacy_level?: number // 0-10 scale for emotional closeness
    dependency_level?: number // 0-10 scale for how much they need each other
    trust_level?: number // 0-10 scale
    respect_level?: number // 0-10 scale
    power_balance?: 'equal' | 'character_1_dominant' | 'character_2_dominant' | 'shifting'
    relationship_arc?: Array<{
      phase: string
      description: string
      chapters: string[]
      key_scenes: string[]
    }>
    conflict_sources?: string[] // money, values, goals, past, secrets, etc.
    bonding_factors?: string[] // shared_experiences, common_goals, mutual_respect, etc.
    relationship_goals?: string // where should this relationship go
    story_importance?: 'primary' | 'secondary' | 'background'
    [key: string]: any
  }
  tags: string[]
  project_id: string
  created_at: string
  updated_at: string
  category: string
}

interface Character {
  id: string
  name: string
  description: string
  category: string
}

interface RelationshipsPanelProps {
  projectId: string
  selectedElement?: any
  onRelationshipsChange?: () => void
  onClearSelection?: () => void
}

const RELATIONSHIP_TYPES = [
  { value: 'romantic', label: 'Romantic', icon: Heart, color: 'rose', description: 'Love, attraction, partnership' },
  { value: 'familial', label: 'Family', icon: Users, color: 'blue', description: 'Blood relations, chosen family' },
  { value: 'friendship', label: 'Friendship', icon: User, color: 'green', description: 'Platonic bonds, companionship' },
  { value: 'rivalry', label: 'Rivalry', icon: Flame, color: 'red', description: 'Competition, antagonism' },
  { value: 'professional', label: 'Professional', icon: Shield, color: 'purple', description: 'Work relationships, business' },
  { value: 'mentorship', label: 'Mentorship', icon: Target, color: 'amber', description: 'Teacher-student, guidance' },
  { value: 'alliance', label: 'Alliance', icon: Link2, color: 'cyan', description: 'Strategic partnerships' },
  { value: 'conflict', label: 'Conflict', icon: Zap, color: 'orange', description: 'Enemies, adversaries' },
  { value: 'hierarchy', label: 'Hierarchy', icon: Crown, color: 'violet', description: 'Power structures, authority' },
  { value: 'dependency', label: 'Dependency', icon: GitBranch, color: 'teal', description: 'One-sided reliance' },
  { value: 'relationship_web', label: 'Visual Web', icon: Network, color: 'indigo', description: 'Canvas-based relationship network' },
  { value: 'other', label: 'Other', icon: MessageCircle, color: 'gray', description: 'Custom relationship type' }
]

const RELATIONSHIP_STATUS = [
  { value: 'developing', label: 'Developing', color: 'blue', description: 'Relationship is forming' },
  { value: 'active', label: 'Active', color: 'green', description: 'Currently engaged relationship' },
  { value: 'strained', label: 'Strained', color: 'yellow', description: 'Under tension or pressure' },
  { value: 'complicated', label: 'Complicated', color: 'orange', description: 'Complex, mixed dynamics' },
  { value: 'former', label: 'Former', color: 'gray', description: 'Past relationship, no longer active' },
  { value: 'broken', label: 'Broken', color: 'red', description: 'Severed or destroyed relationship' },
  { value: 'unknown', label: 'Unknown', color: 'slate', description: 'Status unclear or undefined' },
  { value: 'secret', label: 'Secret', color: 'purple', description: 'Hidden from others' }
]

const RELATIONSHIP_DYNAMICS = [
  'mutual_respect', 'one_sided', 'toxic', 'supportive', 'competitive',
  'protective', 'dependent', 'manipulative', 'inspiring', 'challenging',
  'nurturing', 'conflicted', 'secretive', 'open', 'balanced',
  'volatile', 'stable', 'passionate', 'distant', 'codependent'
]

const CONFLICT_SOURCES = [
  'money', 'values', 'goals', 'past_betrayal', 'secrets', 'jealousy',
  'power', 'resources', 'territory', 'ideology', 'love_triangle',
  'family_honor', 'revenge', 'misunderstanding', 'competition'
]

const BONDING_FACTORS = [
  'shared_trauma', 'common_goals', 'mutual_respect', 'shared_values',
  'complementary_skills', 'similar_background', 'shared_secrets',
  'mutual_protection', 'intellectual_connection', 'emotional_support'
]

const POWER_BALANCE_OPTIONS = [
  { value: 'equal', label: 'Equal Partnership', description: 'Both have equal influence' },
  { value: 'character_1_dominant', label: 'First Character Dominant', description: 'First character has more control' },
  { value: 'character_2_dominant', label: 'Second Character Dominant', description: 'Second character has more control' },
  { value: 'shifting', label: 'Shifting Power', description: 'Power changes based on situation' }
]

const STORY_IMPORTANCE = [
  { value: 'primary', label: 'Primary', color: 'red', description: 'Central to main plot' },
  { value: 'secondary', label: 'Secondary', color: 'amber', description: 'Important subplot element' },
  { value: 'background', label: 'Background', color: 'gray', description: 'Adds depth and context' }
]

// Helper functions for relationship display
function getRelationshipTypeIcon(type: string) {
  const relationshipType = RELATIONSHIP_TYPES.find(t => t.value === type)
  return relationshipType ? relationshipType.icon : Heart
}

function getRelationshipTypeColor(type: string) {
  const relationshipType = RELATIONSHIP_TYPES.find(t => t.value === type)
  return relationshipType ? relationshipType.color : 'gray'
}

function getStatusColor(status: string) {
  const statusObj = RELATIONSHIP_STATUS.find(s => s.value === status)
  return statusObj ? statusObj.color : 'gray'
}

// Component for individual relationship card
const RelationshipCard = React.memo(({ 
  relationship, 
  onEdit, 
  onDelete 
}: { 
  relationship: Relationship
  onEdit: (rel: Relationship) => void
  onDelete: (id: string) => void 
}) => {
  const TypeIcon = getRelationshipTypeIcon(relationship.attributes?.type || '')
  const typeColor = getRelationshipTypeColor(relationship.attributes?.type || '')
  const statusColor = getStatusColor(relationship.attributes?.status || 'active')
  
  return (
    <Card 
      className="hover:shadow-md transition-shadow border border-gray-200 cursor-pointer" 
      onClick={() => onEdit(relationship)}
    >
      <CardHeader className="pb-3">
        <div className="flex items-start justify-between">
          <div className="flex items-center gap-2">
            <TypeIcon className={`w-5 h-5 text-${typeColor}-500`} />
            <div>
              <CardTitle className="text-lg font-semibold truncate">
                {relationship.name}
              </CardTitle>
              <div className="flex items-center gap-2 mt-1">
                <Badge 
                  variant="secondary" 
                  className={`bg-${statusColor}-100 text-${statusColor}-700`}
                >
                  {RELATIONSHIP_STATUS.find(s => s.value === relationship.attributes?.status)?.label || 'Active'}
                </Badge>
                {relationship.attributes?.strength && (
                  <Badge variant="outline">
                    Strength: {relationship.attributes.strength}/10
                  </Badge>
                )}
                {relationship.attributes?.story_importance && (
                  <Badge 
                    variant="outline"
                    className={`bg-${STORY_IMPORTANCE.find(s => s.value === relationship.attributes?.story_importance)?.color}-100`}
                  >
                    {STORY_IMPORTANCE.find(s => s.value === relationship.attributes?.story_importance)?.label}
                  </Badge>
                )}
              </div>
            </div>
          </div>
          <Button
            variant="ghost"
            size="sm"
            onClick={(e) => {
              e.stopPropagation()
              onDelete(relationship.id)
            }}
          >
            <Trash2 className="w-4 h-4 text-red-500" />
          </Button>
        </div>
      </CardHeader>
      <CardContent>
        <div className="space-y-3">
          {/* Characters */}
          <div className="flex items-center justify-between">
            <span className="text-sm font-medium text-blue-600">
              {relationship.attributes?.character_1_name || 'Character 1'}
            </span>
            <ArrowRight className="w-4 h-4 text-gray-400" />
            <span className="text-sm font-medium text-blue-600">
              {relationship.attributes?.character_2_name || 'Character 2'}
            </span>
          </div>

          {/* Enhanced Metrics */}
          <div className="grid grid-cols-3 gap-2 text-xs">
            {relationship.attributes?.tension_level !== undefined && (
              <div className="text-center">
                <div className="text-red-500 font-medium">Tension</div>
                <div>{relationship.attributes.tension_level}/10</div>
              </div>
            )}
            {relationship.attributes?.trust_level !== undefined && (
              <div className="text-center">
                <div className="text-blue-500 font-medium">Trust</div>
                <div>{relationship.attributes.trust_level}/10</div>
              </div>
            )}
            {relationship.attributes?.intimacy_level !== undefined && (
              <div className="text-center">
                <div className="text-purple-500 font-medium">Intimacy</div>
                <div>{relationship.attributes.intimacy_level}/10</div>
              </div>
            )}
          </div>

          {/* Description */}
          {relationship.description && (
            <p className="text-sm text-gray-600 line-clamp-3">
              {relationship.description}
            </p>
          )}

          {/* Dynamics */}
          {relationship.attributes?.dynamics && relationship.attributes.dynamics.length > 0 && (
            <div className="flex flex-wrap gap-1">
              {relationship.attributes.dynamics.slice(0, 3).map((dynamic: string) => (
                <Badge key={dynamic} variant="outline" className="text-xs">
                  {dynamic.replace('_', ' ')}
                </Badge>
              ))}
              {relationship.attributes.dynamics.length > 3 && (
                <Badge variant="outline" className="text-xs">
                  +{relationship.attributes.dynamics.length - 3} more
                </Badge>
              )}
            </div>
          )}

          {/* Actions */}
          <div className="flex justify-between items-center pt-2 border-t">
            <Button
              variant="ghost"
              size="sm"
              onClick={(e) => {
                e.stopPropagation()
                onEdit(relationship)
              }}
            >
              <Edit3 className="w-4 h-4 mr-1" />
              Edit
            </Button>
            <span className="text-xs text-gray-500">
              {new Date(relationship.updated_at).toLocaleDateString()}
            </span>
          </div>
        </div>
      </CardContent>
    </Card>
  )
})

RelationshipCard.displayName = "RelationshipCard"

// Flowchart View Component - Campfire-style visual relationship creation
const FlowchartView = React.memo(({ 
  relationships, 
  characters, 
  onCreateRelationship 
}: { 
  relationships: Relationship[]
  characters: Character[]
  onCreateRelationship: (char1Id: string, char2Id: string) => void
}) => {
  const [selectedCharacter, setSelectedCharacter] = useState<string | null>(null)
  const [hoveredCharacter, setHoveredCharacter] = useState<string | null>(null)
  
  const getCharacterConnections = (characterId: string) => {
    return relationships.filter(r => 
      r.attributes?.character_1_id === characterId || 
      r.attributes?.character_2_id === characterId
    ).length
  }

  const getRelationshipBetween = (char1Id: string, char2Id: string) => {
    return relationships.find(r => 
      (r.attributes?.character_1_id === char1Id && r.attributes?.character_2_id === char2Id) ||
      (r.attributes?.character_1_id === char2Id && r.attributes?.character_2_id === char1Id)
    )
  }

  const renderConnectionLines = () => {
    return relationships.map(relationship => {
      const char1 = characters.find(c => c.id === relationship.attributes?.character_1_id)
      const char2 = characters.find(c => c.id === relationship.attributes?.character_2_id)
      if (!char1 || !char2) return null

      const typeColor = getRelationshipTypeColor(relationship.attributes?.type || '')
      const isConflict = relationship.attributes?.type === 'conflict' || relationship.attributes?.type === 'rivalry'

      return (
        <div key={relationship.id} className="absolute inset-0 pointer-events-none">
          <svg className="w-full h-full">
            <line
              x1="50%"
              y1="50%"
              x2="50%"
              y2="50%"
              stroke={`rgb(var(--${typeColor}-500))`}
              strokeWidth={isConflict ? 3 : 2}
              strokeDasharray={isConflict ? "8,4" : "0"}
              opacity={0.6}
              className="connection-line"
            />
          </svg>
        </div>
      )
    })
  }

  if (characters.length === 0) {
    return (
      <div className="text-center py-16">
        <Users className="w-16 h-16 text-gray-300 mx-auto mb-4" />
        <p className="text-gray-600 text-lg mb-2">No Characters Available</p>
        <p className="text-gray-500 text-sm">
          Create characters first to use the flowchart relationship builder
        </p>
      </div>
    )
  }

  return (
    <div className="bg-gradient-to-br from-rose-50 to-pink-50 rounded-2xl border-2 border-rose-100 p-8 min-h-[600px] relative overflow-hidden">
      {/* Instructions */}
      <div className="absolute top-4 left-4 bg-white/80 backdrop-blur-sm rounded-lg p-3 shadow-sm border border-rose-200">
        <p className="text-sm text-gray-600 mb-1">
          <strong>Flowchart Mode:</strong> Click characters to connect them
        </p>
        <p className="text-xs text-gray-500">
          {selectedCharacter ? 'Now click another character to create a relationship' : 'Select a character to start'}
        </p>
      </div>

      {/* Legend */}
      <div className="absolute top-4 right-4 bg-white/80 backdrop-blur-sm rounded-lg p-3 shadow-sm border border-rose-200">
        <div className="text-sm font-medium text-gray-700 mb-2">Connections</div>
        <div className="space-y-1 text-xs">
          <div className="flex items-center gap-2">
            <div className="w-3 h-0.5 bg-green-500"></div>
            <span>Friendly</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-3 h-0.5 bg-red-500 border-dashed"></div>
            <span>Conflict</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-3 h-0.5 bg-rose-500"></div>
            <span>Romantic</span>
          </div>
        </div>
      </div>

      {/* Character Nodes */}
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-6 pt-20">
        {characters.map(character => {
          const isSelected = selectedCharacter === character.id
          const isHovered = hoveredCharacter === character.id
          const connections = getCharacterConnections(character.id)
          const hasConnectionToSelected = selectedCharacter && getRelationshipBetween(selectedCharacter, character.id)
          
          return (
            <div
              key={character.id}
              className="relative flex flex-col items-center group cursor-pointer"
              onClick={() => {
                if (selectedCharacter && selectedCharacter !== character.id) {
                  // Create connection
                  onCreateRelationship(selectedCharacter, character.id)
                  setSelectedCharacter(null)
                } else {
                  setSelectedCharacter(character.id === selectedCharacter ? null : character.id)
                }
              }}
              onMouseEnter={() => setHoveredCharacter(character.id)}
              onMouseLeave={() => setHoveredCharacter(null)}
            >
              {/* Connection indicator */}
              <div className={cn(
                "absolute -top-2 -right-2 w-6 h-6 rounded-full text-xs font-bold flex items-center justify-center",
                connections > 0 ? "bg-rose-500 text-white" : "bg-gray-200 text-gray-500"
              )}>
                {connections}
              </div>
              
              {/* Character Circle */}
              <div className={cn(
                "w-16 h-16 rounded-full flex items-center justify-center font-bold text-xl transition-all duration-300",
                "border-4 shadow-lg hover:shadow-xl transform hover:scale-110",
                isSelected ? "bg-rose-500 text-white border-rose-600 shadow-rose-200 scale-110" :
                hasConnectionToSelected ? "bg-blue-100 border-blue-300 text-blue-700" :
                isHovered ? "bg-rose-100 border-rose-300 text-rose-700" :
                "bg-white border-gray-300 text-gray-700 hover:border-rose-300"
              )}>
                {character.name.charAt(0).toUpperCase()}
              </div>
              
              {/* Character Name */}
              <div className="mt-3 text-center">
                <div className={cn(
                  "font-medium text-sm transition-colors duration-300",
                  isSelected ? "text-rose-600" : "text-gray-700 group-hover:text-rose-600"
                )}>
                  {character.name}
                </div>
                {connections > 0 && (
                  <div className="text-xs text-gray-500">
                    {connections} connection{connections !== 1 ? 's' : ''}
                  </div>
                )}
              </div>
              
              {/* Selection Highlight */}
              {isSelected && (
                <div className="absolute inset-0 rounded-full border-4 border-rose-400 animate-pulse pointer-events-none scale-125"></div>
              )}
              
              {/* Hover Effect */}
              {isHovered && !isSelected && (
                <div className="absolute inset-0 rounded-full bg-rose-100 opacity-20 scale-125 pointer-events-none"></div>
              )}
            </div>
          )
        })}
      </div>

      {/* Connection Lines */}
      {renderConnectionLines()}
      
      {/* Empty State */}
      {relationships.length === 0 && (
        <div className="absolute inset-0 flex items-center justify-center">
          <div className="text-center bg-white/60 backdrop-blur-sm rounded-2xl p-8 border-2 border-dashed border-rose-200">
            <Heart className="w-12 h-12 text-rose-300 mx-auto mb-4" />
            <p className="text-rose-600 font-medium">Start Creating Connections</p>
            <p className="text-rose-500 text-sm">Click on characters to connect them</p>
          </div>
        </div>
      )}
    </div>
  )
})

FlowchartView.displayName = "FlowchartView"

// Network View Component
const NetworkView = React.memo(({ 
  relationships, 
  characters, 
  networkData 
}: { 
  relationships: Relationship[]
  characters: Character[]
  networkData: { nodes: any[], links: any[] }
}) => {
  return (
    <div className="h-96 border rounded-lg bg-gray-50 flex items-center justify-center">
      <div className="text-center">
        <Network className="w-16 h-16 text-gray-300 mx-auto mb-4" />
        <p className="text-gray-600 text-lg mb-2">Network View</p>
        <p className="text-gray-500 text-sm">
          Interactive relationship network visualization coming soon
        </p>
      </div>
    </div>
  )
})

NetworkView.displayName = "NetworkView"

// Matrix View Component
const MatrixView = React.memo(({ 
  characters, 
  relationships, 
  matrix 
}: { 
  characters: Character[]
  relationships: Relationship[]
  matrix: Array<Array<Relationship | null>>
}) => {
  if (characters.length === 0) {
    return (
      <div className="text-center py-12">
        <BarChart3 className="w-16 h-16 text-gray-300 mx-auto mb-4" />
        <p className="text-gray-600">No characters available for matrix view</p>
      </div>
    )
  }

  return (
    <div className="overflow-x-auto">
      <table className="min-w-full border border-gray-200">
        <thead>
          <tr className="bg-gray-50">
            <th className="border border-gray-200 p-2 text-left font-medium">Character</th>
            {characters.map(char => (
              <th key={char.id} className="border border-gray-200 p-2 text-center font-medium min-w-24">
                <div className="truncate" title={char.name}>
                  {char.name.slice(0, 8)}...
                </div>
              </th>
            ))}
          </tr>
        </thead>
        <tbody>
          {characters.map((char1, i) => (
            <tr key={char1.id}>
              <td className="border border-gray-200 p-2 font-medium bg-gray-50">
                {char1.name}
              </td>
              {characters.map((char2, j) => {
                const relationship = matrix[i][j]
                const isSelf = i === j
                
                return (
                  <td key={char2.id} className="border border-gray-200 p-1 text-center">
                    {isSelf ? (
                      <div className="w-6 h-6 bg-gray-200 rounded mx-auto"></div>
                    ) : relationship ? (
                      <div 
                        className={`w-6 h-6 rounded mx-auto bg-${getRelationshipTypeColor(relationship.attributes?.type || '')}-500`}
                        title={`${relationship.name} (${relationship.attributes?.type})`}
                      ></div>
                    ) : (
                      <div className="w-6 h-6 border border-gray-300 rounded mx-auto bg-white"></div>
                    )}
                  </td>
                )
              })}
            </tr>
          ))}
        </tbody>
      </table>
      
      {/* Legend */}
      <div className="mt-4 flex flex-wrap gap-4 text-sm">
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 bg-gray-200 rounded"></div>
          <span>Self</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 border border-gray-300 rounded bg-white"></div>
          <span>No relationship</span>
        </div>
        {RELATIONSHIP_TYPES.slice(0, 5).map(type => (
          <div key={type.value} className="flex items-center gap-2">
            <div className={`w-4 h-4 bg-${type.color}-500 rounded`}></div>
            <span>{type.label}</span>
          </div>
        ))}
      </div>
    </div>
  )
})

MatrixView.displayName = "MatrixView"

// Timeline View Component
const TimelineView = React.memo(({ relationships }: { relationships: Relationship[] }) => {
  const relationshipsWithEvents = relationships.filter(r => 
    r.attributes?.timeline_events && r.attributes.timeline_events.length > 0
  )

  if (relationshipsWithEvents.length === 0) {
    return (
      <div className="text-center py-12">
        <Activity className="w-16 h-16 text-gray-300 mx-auto mb-4" />
        <p className="text-gray-600 text-lg mb-2">No timeline events</p>
        <p className="text-gray-500 text-sm">
          Add timeline events to your relationships to see their development over time
        </p>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {relationshipsWithEvents.map(relationship => (
        <Card key={relationship.id} className="p-4">
          <h3 className="font-semibold mb-3 flex items-center gap-2">
            <Heart className="w-4 h-4 text-rose-500" />
            {relationship.name}
          </h3>
          <div className="space-y-2">
            {relationship.attributes?.timeline_events?.map((event, index) => (
              <div key={index} className="flex items-start gap-3 p-2 bg-gray-50 rounded">
                <div className="text-xs text-gray-500 min-w-20">{event.date}</div>
                <div className="flex-1">
                  <div className="font-medium text-sm">{event.event}</div>
                  {event.description && (
                    <div className="text-sm text-gray-600">{event.description}</div>
                  )}
                </div>
              </div>
            ))}
          </div>
        </Card>
      ))}
    </div>
  )
})

TimelineView.displayName = "TimelineView"

const RelationshipsPanel = ({ 
  projectId, 
  selectedElement, 
  onRelationshipsChange,
  onClearSelection 
}: RelationshipsPanelProps) => {
  const [relationships, setRelationships] = useState<Relationship[]>([])
  const [characters, setCharacters] = useState<Character[]>([])
  const [loading, setLoading] = useState(true)
  const [searchTerm, setSearchTerm] = useState('')
  const [selectedType, setSelectedType] = useState<string>('all')
  const [selectedStatus, setSelectedStatus] = useState<string>('all')
  const [showCreateDialog, setShowCreateDialog] = useState(false)
  const [editingRelationship, setEditingRelationship] = useState<Relationship | null>(null)
  const [viewMode, setViewMode] = useState<'grid' | 'network' | 'matrix' | 'timeline' | 'flowchart'>('grid')
  const [activeTab, setActiveTab] = useState<'overview' | 'dynamics' | 'timeline' | 'analysis'>('overview')
  const [showFlowchartDialog, setShowFlowchartDialog] = useState(false)
  const [selectedCharacters, setSelectedCharacters] = useState<string[]>([])
  const [flowchartStep, setFlowchartStep] = useState<'select' | 'connect' | 'define'>('select')
  
  // Quick Connect Dialog state
  const [showQuickConnect, setShowQuickConnect] = useState(false)
  const [quickConnectChar1, setQuickConnectChar1] = useState<string>('')
  const [quickConnectChar2, setQuickConnectChar2] = useState<string>('')
  const [quickConnectType, setQuickConnectType] = useState<string>('friendship')
  const [quickConnectIntensity, setQuickConnectIntensity] = useState<number>(5)
  
  // Canvas-based relationship creation state
  const [showNameInput, setShowNameInput] = useState(false)
  const [relationshipName, setRelationshipName] = useState('')
  const [showCanvas, setShowCanvas] = useState(false) // New state for canvas creation interface
  
  const networkRef = useRef<HTMLDivElement>(null)
  
  // Enhanced form state for Campfire-style features
  const [formData, setFormData] = useState({
    name: '',
    description: '',
    type: '',
    strength: 5,
    status: 'active',
    character_1_id: '',
    character_2_id: '',
    dynamics: [] as string[],
    history: '',
    current_state: '',
    notes: '',
    // Enhanced fields
    tension_level: 0,
    intimacy_level: 5,
    dependency_level: 0,
    trust_level: 5,
    respect_level: 5,
    power_balance: 'equal' as 'equal' | 'character_1_dominant' | 'character_2_dominant' | 'shifting',
    conflict_sources: [] as string[],
    bonding_factors: [] as string[],
    relationship_goals: '',
    story_importance: 'secondary' as 'primary' | 'secondary' | 'background'
  })

  const supabase = createSupabaseClient()

  useEffect(() => {
    loadRelationships()
    loadCharacters()
  }, [projectId])

  useEffect(() => {
    if (selectedElement && selectedElement.category === 'relationships') {
      console.log('🎯 SELECTED ELEMENT: Opening canvas for:', selectedElement.name)
      // Always open canvas for any relationship
      setRelationshipName(selectedElement.name)
      setEditingRelationship(selectedElement)
      setShowCanvas(true)
    }
    
    // Cleanup function to prevent memory leaks
    return () => {
      if (selectedElement && selectedElement.category === 'relationships') {
        console.log('🧹 CLEANUP: Clearing relationship selection')
      }
    }
  }, [selectedElement])

  // Listen for canvas relationship events from sidebar
  useEffect(() => {
    const handleOpenRelationshipCanvas = (event: any) => {
      console.log('🎯 RECEIVED openRelationshipCanvas event:', event.detail?.relationship?.name)
      const relationship = event.detail.relationship
      
      // Always open canvas for any relationship
      if (relationship) {
        console.log('🎯 OPENING CANVAS from event')
        setRelationshipName(relationship.name)
        setEditingRelationship(relationship)
        setShowCanvas(true)
      }
    }

    window.addEventListener('openRelationshipCanvas', handleOpenRelationshipCanvas)
    return () => {
      window.removeEventListener('openRelationshipCanvas', handleOpenRelationshipCanvas)
    }
  }, [])

  const loadRelationships = async () => {
    try {
      const { data, error } = await supabase
        .from('world_elements')
        .select('*')
        .eq('project_id', projectId)
        .eq('category', 'relationships')
        .order('created_at', { ascending: false })

      if (error) throw error
      setRelationships(data || [])
    } catch (error) {
      console.error('Error loading relationships:', error)
    } finally {
      setLoading(false)
    }
  }

  const loadCharacters = async () => {
    try {
      const { data, error } = await supabase
        .from('world_elements')
        .select('id, name, description, category')
        .eq('project_id', projectId)
        .eq('category', 'characters')
        .order('name')

      if (error) throw error
      setCharacters(data || [])
    } catch (error) {
      console.error('Error loading characters:', error)
    }
  }

  const filteredRelationships = relationships.filter(relationship => {
    const matchesSearch = !searchTerm || 
      relationship.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      relationship.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
      relationship.attributes?.character_1_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      relationship.attributes?.character_2_name?.toLowerCase().includes(searchTerm.toLowerCase())
    
    const matchesType = selectedType === 'all' || !selectedType || relationship.attributes?.type === selectedType
    const matchesStatus = selectedStatus === 'all' || !selectedStatus || relationship.attributes?.status === selectedStatus
    
    return matchesSearch && matchesType && matchesStatus
  })

  const handleCreateRelationship = async () => {
    try {
      const character1 = characters.find(c => c.id === formData.character_1_id)
      const character2 = characters.find(c => c.id === formData.character_2_id)

      if (!character1 || !character2) {
        console.error('Missing character selection:', { character1: !!character1, character2: !!character2 })
        alert('Please select both characters for the relationship')
        return
      }

      const relationshipData = {
        project_id: projectId,
        category: 'relationships',
        name: formData.name || `${character1.name} & ${character2.name}`,
        description: formData.description,
        attributes: {
          type: formData.type,
          strength: formData.strength,
          status: formData.status,
          character_1_id: formData.character_1_id,
          character_1_name: character1.name,
          character_2_id: formData.character_2_id,
          character_2_name: character2.name,
          dynamics: formData.dynamics,
          history: formData.history,
          current_state: formData.current_state,
          notes: formData.notes,
          // Enhanced Campfire-style fields
          tension_level: formData.tension_level,
          intimacy_level: formData.intimacy_level,
          dependency_level: formData.dependency_level,
          trust_level: formData.trust_level,
          respect_level: formData.respect_level,
          power_balance: formData.power_balance,
          conflict_sources: formData.conflict_sources,
          bonding_factors: formData.bonding_factors,
          relationship_goals: formData.relationship_goals,
          story_importance: formData.story_importance,
          timeline_events: []
        },
        tags: []
      }

      let result: Relationship
      if (editingRelationship) {
        const { data, error } = await supabase
          .from('world_elements')
          .update({ ...relationshipData, updated_at: new Date().toISOString() })
          .eq('id', editingRelationship.id)
          .select()
          .single()

        if (error) {
          console.error('Update error:', error)
          throw new Error(`Failed to update relationship: ${error.message}`)
        }
        result = data as Relationship

        setRelationships(prev => prev.map(r => r.id === editingRelationship.id ? result : r))
      } else {
        const { data, error } = await supabase
          .from('world_elements')
          .insert(relationshipData)
          .select()
          .single()

        if (error) {
          console.error('Insert error:', error)
          throw new Error(`Failed to create relationship: ${error.message}`)
        }
        result = data as Relationship

        setRelationships(prev => [result, ...prev])
      }

      // Broadcast change
      window.dispatchEvent(new CustomEvent('relationshipCreated', { 
        detail: { relationship: result, projectId } 
      }))

      setShowCreateDialog(false)
      setEditingRelationship(null)
      resetForm()
      onRelationshipsChange?.()
    } catch (error) {
      console.error('Error creating/updating relationship:', error)
      // Show user-friendly error message
      alert(error instanceof Error ? error.message : 'An unexpected error occurred while saving the relationship')
    }
  }

  const handleDeleteRelationship = async (id: string) => {
    if (!confirm('Are you sure you want to delete this relationship?')) return

    try {
      const { error } = await supabase
        .from('world_elements')
        .delete()
        .eq('id', id)

      if (error) throw error

      setRelationships(prev => prev.filter(r => r.id !== id))
      onRelationshipsChange?.()
    } catch (error) {
      console.error('Error deleting relationship:', error)
    }
  }

  // Quick Connect handler for flowchart-style relationship creation
  const handleQuickConnect = async (char1Id?: string, char2Id?: string) => {
    const character1Id = char1Id || quickConnectChar1
    const character2Id = char2Id || quickConnectChar2
    
    if (!character1Id || !character2Id) return
    
    const character1 = characters.find(c => c.id === character1Id)
    const character2 = characters.find(c => c.id === character2Id)
    
    if (!character1 || !character2) return
    
    try {
      const relationshipData = {
        project_id: projectId,
        category: 'relationships',
        name: `${character1.name} & ${character2.name}`,
        type: 'character',
        attributes: {
          name: `${character1.name} & ${character2.name}`,
          type: char1Id ? 'friendship' : quickConnectType,
          strength: char1Id ? 5 : quickConnectIntensity,
          status: 'active',
          character_1_id: character1Id,
          character_2_id: character2Id,
          description: `${char1Id ? 'friendship' : quickConnectType} relationship`,
          dynamics: [],
          history: '',
          current_state: 'developing',
          notes: '',
          tension_level: (char1Id ? 'friendship' : quickConnectType) === 'conflict' ? 7 : (char1Id ? 'friendship' : quickConnectType) === 'rivalry' ? 5 : 2,
          intimacy_level: (char1Id ? 'friendship' : quickConnectType) === 'romance' ? 8 : (char1Id ? 'friendship' : quickConnectType) === 'family' ? 7 : 5,
          dependency_level: (char1Id ? 5 : quickConnectIntensity) >= 7 ? 6 : 3,
          trust_level: (char1Id ? 'friendship' : quickConnectType) === 'conflict' ? 2 : (char1Id ? 'friendship' : quickConnectType) === 'rivalry' ? 4 : 7,
          respect_level: (char1Id ? 5 : quickConnectIntensity) >= 6 ? 7 : 5,
          power_balance: 'equal',
          conflict_sources: [],
          bonding_factors: [],
          relationship_goals: [],
          story_importance: 'moderate',
          timeline_events: []
        },
        tags: []
      }

      const { data, error } = await supabase
        .from('world_elements')
        .insert(relationshipData)
        .select()
        .single()

      if (error) throw error
      const result = data as Relationship

      setRelationships(prev => [result, ...prev])
      
      // Broadcast change
      window.dispatchEvent(new CustomEvent('relationshipCreated', { 
        detail: { relationship: result, projectId } 
      }))

      if (!char1Id) {
        // Reset dialog if opened from Quick Connect
        setShowQuickConnect(false)
        setQuickConnectChar1('')
        setQuickConnectChar2('')
        setQuickConnectType('friendship')
        setQuickConnectIntensity(5)
      }
      
      onRelationshipsChange?.()
    } catch (error) {
      console.error('Error creating relationship:', error)
    }
  }

  // Handle saving canvas-based relationship
  const handleSaveCanvasRelationship = async (canvasData: { nodes: CanvasNode[], connections: CanvasConnection[] }) => {
    try {
      const supabase = createSupabaseClient()
      
      // Debug logging
      console.log('Canvas save debug:', {
        relationshipName,
        projectId,
        editingRelationship: editingRelationship?.id,
        canvasDataNodes: canvasData?.nodes?.length || 0,
        canvasDataConnections: canvasData?.connections?.length || 0,
        canvasData
      })
      
      // Validate required data
      if (!projectId) {
        console.error('No projectId provided')
        return
      }
      
      if (!canvasData || !canvasData.nodes || !canvasData.connections) {
        console.error('Invalid canvas data:', canvasData)
        return
      }
      
      // Generate a name if none is provided
      const webName = relationshipName?.trim() || (editingRelationship?.name) || `Relationship Web - ${new Date().toLocaleDateString()}`
      
      // Create the relationship web data
      const relationshipWebData = {
        name: webName,
        description: `Visual relationship web showing connections between ${canvasData.nodes.length} elements`,
        category: 'relationships',
        project_id: projectId,
        attributes: {
          type: 'relationship_web',
          canvas_data: canvasData,
          created_at: editingRelationship?.attributes?.created_at || new Date().toISOString(),
          updated_at: new Date().toISOString()
        },
        tags: ['relationship', 'visual', 'canvas']
      }

      console.log('Relationship web object:', JSON.stringify(relationshipWebData, null, 2))

      let data: any, error: any

      if (editingRelationship) {
        // Update existing relationship
        const updateResult = await supabase
          .from('world_elements')
          .update(relationshipWebData)
          .eq('id', editingRelationship.id)
          .select()
          .single()
        
        data = updateResult.data
        error = updateResult.error
        
        if (!error && data) {
          // Update the relationships list
          setRelationships(prev => prev.map(r => r.id === editingRelationship.id ? data : r))
        }
      } else {
        // Create new relationship
        const insertResult = await supabase
          .from('world_elements')
          .insert(relationshipWebData)
          .select()
          .single()
        
        data = insertResult.data
        error = insertResult.error
        
        if (!error && data) {
          // Add to relationships list
          setRelationships(prev => [data, ...prev])
        }
      }

      if (error) {
        console.error('Error saving relationship web:', JSON.stringify(error, null, 2))
        console.error('Attempted to save:', JSON.stringify(relationshipWebData, null, 2))
        return
      }

      if (!data) {
        console.error('No data returned from relationship web insert')
        console.error('Insert result - data:', data, 'error:', error)
        return
      }

      const savedRelationshipWeb = data

      // Refresh the relationships list
      await loadRelationships()
      
      // Broadcast change for sidebar update
      if (editingRelationship) {
        window.dispatchEvent(new CustomEvent('relationshipUpdated', { 
          detail: { relationship: savedRelationshipWeb, projectId } 
        }))
      } else {
        window.dispatchEvent(new CustomEvent('relationshipCreated', { 
          detail: { relationship: savedRelationshipWeb, projectId } 
        }))
      }

      // Clear editing state
      setEditingRelationship(null)
      
      onRelationshipsChange?.()
    } catch (error) {
      console.error('Error saving canvas relationship:', error)
    }
  }

  const resetForm = () => {
    setFormData({
      name: '',
      description: '',
      type: '',
      strength: 5,
      status: 'active',
      character_1_id: '',
      character_2_id: '',
      dynamics: [],
      history: '',
      current_state: '',
      notes: '',
      // Enhanced fields
      tension_level: 0,
      intimacy_level: 5,
      dependency_level: 0,
      trust_level: 5,
      respect_level: 5,
      power_balance: 'equal',
      conflict_sources: [],
      bonding_factors: [],
      relationship_goals: '',
      story_importance: 'secondary'
    })
  }

  // Network view helpers
  const generateNetworkData = useCallback(() => {
    const nodes = characters.map(character => ({
      id: character.id,
      name: character.name,
      type: 'character',
      connections: relationships.filter(r => 
        r.attributes?.character_1_id === character.id || 
        r.attributes?.character_2_id === character.id
      ).length
    }))

    const links = relationships.map(relationship => ({
      source: relationship.attributes?.character_1_id,
      target: relationship.attributes?.character_2_id,
      type: relationship.attributes?.type,
      strength: relationship.attributes?.strength || 5,
      tension: relationship.attributes?.tension_level || 0,
      status: relationship.attributes?.status,
      relationship: relationship
    })).filter(link => link.source && link.target)

    return { nodes, links }
  }, [characters, relationships])

  // Character relationship matrix
  const generateMatrix = useCallback(() => {
    const matrix: Array<Array<Relationship | null>> = []
    
    characters.forEach((char1, i) => {
      matrix[i] = []
      characters.forEach((char2, j) => {
        if (i === j) {
          matrix[i][j] = null // Same character
        } else {
          const relationship = relationships.find(r => 
            (r.attributes?.character_1_id === char1.id && r.attributes?.character_2_id === char2.id) ||
            (r.attributes?.character_1_id === char2.id && r.attributes?.character_2_id === char1.id)
          )
          matrix[i][j] = relationship || null
        }
      })
    })
    
    return matrix
  }, [characters, relationships])

  // Analytics calculations
  const relationshipAnalytics = useCallback(() => {
    const totalRelationships = relationships.length
    const activeRelationships = relationships.filter(r => r.attributes?.status === 'active').length
    const conflictRelationships = relationships.filter(r => 
      r.attributes?.type === 'conflict' || r.attributes?.type === 'rivalry'
    ).length
    const romanticRelationships = relationships.filter(r => r.attributes?.type === 'romantic').length
    
    const avgTension = relationships.reduce((sum, r) => sum + (r.attributes?.tension_level || 0), 0) / totalRelationships || 0
    const avgIntimacy = relationships.reduce((sum, r) => sum + (r.attributes?.intimacy_level || 0), 0) / totalRelationships || 0
    
    const mostConnectedCharacter = characters.reduce((max, char) => {
      const connections = relationships.filter(r => 
        r.attributes?.character_1_id === char.id || r.attributes?.character_2_id === char.id
      ).length
      return connections > max.connections ? { character: char, connections } : max
    }, { character: null as Character | null, connections: 0 })

    return {
      totalRelationships,
      activeRelationships,
      conflictRelationships,
      romanticRelationships,
      avgTension: Math.round(avgTension * 10) / 10,
      avgIntimacy: Math.round(avgIntimacy * 10) / 10,
      mostConnectedCharacter
    }
  }, [relationships, characters])

  if (loading) {
    return (
      <div className="h-full bg-white p-6 overflow-y-auto">
        <div className="max-w-5xl mx-auto">
          <div className="animate-pulse">
            <div className="h-8 bg-gray-200 rounded w-48 mb-4"></div>
            <div className="space-y-4">
              {[...Array(3)].map((_, i) => (
                <div key={i} className="h-32 bg-gray-100 rounded-lg"></div>
              ))}
            </div>
          </div>
        </div>
      </div>
    )
  }

  // Show canvas full-screen when creating a new relationship
  if (showCanvas) {
    return (
      <div className="h-full bg-white">
        <InlineRelationshipCanvas
          relationshipName={relationshipName}
          characters={characters}
          existingRelationship={editingRelationship}
          onClose={() => {
            setShowCanvas(false)
            setRelationshipName('')
          }}
          onSave={async (canvasData: { nodes: CanvasNode[], connections: CanvasConnection[] }) => {
            await handleSaveCanvasRelationship(canvasData)
            setShowCanvas(false)
            setRelationshipName('')
          }}
        />
      </div>
    )
  }

  return (
    <div className="h-full bg-white p-6 overflow-y-auto">
      <div className="max-w-5xl mx-auto">
        {/* Header */}
        <div className="flex items-center justify-between mb-6">
          <div>
            <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
              <Heart className="w-7 h-7 text-rose-500" />
              Relationships
            </h2>
            <p className="text-sm text-gray-500">Map connections, dynamics, and story arcs between characters</p>
          </div>
          <div className="flex items-center gap-2">
            {/* View Mode Toggle */}
            <div className="flex items-center bg-gray-100 rounded-lg p-1">
              <Button
                variant={viewMode === 'grid' ? 'default' : 'ghost'}
                size="sm"
                onClick={() => setViewMode('grid')}
                className="text-xs px-3"
              >
                <Grid className="w-4 h-4 mr-1" />
                Grid
              </Button>
              <Button
                variant={viewMode === 'flowchart' ? 'default' : 'ghost'}
                size="sm"
                onClick={() => setViewMode('flowchart')}
                className="text-xs px-3"
              >
                <GitBranch className="w-4 h-4 mr-1" />
                Flow
              </Button>
              <Button
                variant={viewMode === 'network' ? 'default' : 'ghost'}
                size="sm"
                onClick={() => setViewMode('network')}
                className="text-xs px-3"
              >
                <Network className="w-4 h-4 mr-1" />
                Network
              </Button>
              <Button
                variant={viewMode === 'matrix' ? 'default' : 'ghost'}
                size="sm"
                onClick={() => setViewMode('matrix')}
                className="text-xs px-3"
              >
                <BarChart3 className="w-4 h-4 mr-1" />
                Matrix
              </Button>
              <Button
                variant={viewMode === 'timeline' ? 'default' : 'ghost'}
                size="sm"
                onClick={() => setViewMode('timeline')}
                className="text-xs px-3"
              >
                <Activity className="w-4 h-4 mr-1" />
                Timeline
              </Button>
            </div>
            
            {/* Create Buttons */}
            <div className="flex gap-2">
              <Button
                variant="outline"
                onClick={() => {
                  setShowQuickConnect(true)
                }}
                className="border-rose-200 text-rose-600 hover:bg-rose-50"
              >
                <Zap className="w-4 h-4 mr-2" />
                Quick Connect
              </Button>
              {!showNameInput ? (
                <Button
                  onClick={() => setShowNameInput(true)}
                  className="bg-gradient-to-r from-rose-500 to-pink-500 hover:from-rose-600 hover:to-pink-600 text-white shadow-lg"
                >
                  <Plus className="w-4 h-4 mr-2" />
                  New Relationship
                </Button>
              ) : (
                <div className="flex items-center gap-3">
                  <EnhancedInput
                    placeholder="Enter relationship name..."
                    value={relationshipName}
                    onChange={(e: React.ChangeEvent<HTMLInputElement>) => setRelationshipName(e.target.value)}
                    onKeyDown={(e: React.KeyboardEvent<HTMLInputElement>) => {
                      if (e.key === 'Enter' && relationshipName.trim()) {
                        setShowCanvas(true)
                        setShowNameInput(false)
                      } else if (e.key === 'Escape') {
                        setShowNameInput(false)
                        setRelationshipName('')
                      }
                    }}
                    className="min-w-[300px]"
                    autoFocus
                  />
                  <Button
                    onClick={() => {
                      if (relationshipName.trim()) {
                        setShowCanvas(true)
                        setShowNameInput(false)
                      }
                    }}
                    disabled={!relationshipName.trim()}
                    className="bg-gradient-to-r from-rose-500 to-pink-500 hover:from-rose-600 hover:to-pink-600 text-white shadow-lg"
                  >
                    <ArrowRight className="w-4 h-4" />
                  </Button>
                  <Button
                    variant="outline"
                    onClick={() => {
                      setShowNameInput(false)
                      setRelationshipName('')
                    }}
                    className="border-gray-300 hover:border-gray-400"
                  >
                    <X className="w-4 h-4" />
                  </Button>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Filters */}
        <div className="flex flex-wrap items-center gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
          <div className="flex-1 min-w-64">
            <Input
              placeholder="Search relationships..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="bg-white"
            />
          </div>
          <Select value={selectedType} onValueChange={setSelectedType}>
            <SelectTrigger className="w-48 bg-white">
              <SelectValue placeholder="Filter by type" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Types</SelectItem>
              {RELATIONSHIP_TYPES.map(type => (
                <SelectItem key={type.value} value={type.value}>
                  <div className="flex items-center gap-2">
                    <type.icon className="w-4 h-4" />
                    {type.label}
                  </div>
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
          <Select value={selectedStatus} onValueChange={setSelectedStatus}>
            <SelectTrigger className="w-48 bg-white">
              <SelectValue placeholder="Filter by status" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Statuses</SelectItem>
              {RELATIONSHIP_STATUS.map(status => (
                <SelectItem key={status.value} value={status.value}>
                  <div className="flex items-center gap-2">
                    <div className={`w-2 h-2 rounded-full bg-${status.color}-500`}></div>
                    {status.label}
                  </div>
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>

        {/* Content */}
        {filteredRelationships.length === 0 ? (
          <div className="text-center py-12">
            <Heart className="w-16 h-16 text-gray-300 mx-auto mb-4" />
            <p className="text-gray-600 text-lg mb-2">No relationships yet</p>
            <p className="text-gray-500 mb-6">
              Start mapping the connections between your characters to bring depth to your story.
            </p>
            <Button 
              onClick={() => {
                setRelationshipName("First Relationship")
                setShowCanvas(true)
              }}
              className="bg-rose-500 hover:bg-rose-600 text-white"
            >
              <Plus className="w-4 h-4 mr-2" />
              Create First Relationship
            </Button>
          </div>
        ) : (
          <>
            {/* Analytics Dashboard */}
            {viewMode === 'grid' && (
              <div className="mb-8 grid grid-cols-2 md:grid-cols-4 gap-4">
                {(() => {
                  const analytics = relationshipAnalytics()
                  return (
                    <>
                      <Card className="p-4">
                        <div className="flex items-center gap-2 mb-2">
                          <Heart className="w-5 h-5 text-rose-500" />
                          <span className="text-sm font-medium">Total</span>
                        </div>
                        <div className="text-2xl font-bold">{analytics.totalRelationships}</div>
                        <div className="text-xs text-gray-500">{analytics.activeRelationships} active</div>
                      </Card>
                      
                      <Card className="p-4">
                        <div className="flex items-center gap-2 mb-2">
                          <Flame className="w-5 h-5 text-red-500" />
                          <span className="text-sm font-medium">Conflicts</span>
                        </div>
                        <div className="text-2xl font-bold">{analytics.conflictRelationships}</div>
                        <div className="text-xs text-gray-500">Tension avg: {analytics.avgTension}/10</div>
                      </Card>
                      
                      <Card className="p-4">
                        <div className="flex items-center gap-2 mb-2">
                          <Heart className="w-5 h-5 text-pink-500" />
                          <span className="text-sm font-medium">Romance</span>
                        </div>
                        <div className="text-2xl font-bold">{analytics.romanticRelationships}</div>
                        <div className="text-xs text-gray-500">Intimacy avg: {analytics.avgIntimacy}/10</div>
                      </Card>
                      
                      <Card className="p-4">
                        <div className="flex items-center gap-2 mb-2">
                          <Network className="w-5 h-5 text-blue-500" />
                          <span className="text-sm font-medium">Hub</span>
                        </div>
                        <div className="text-lg font-bold truncate">
                          {analytics.mostConnectedCharacter.character?.name || 'None'}
                        </div>
                        <div className="text-xs text-gray-500">
                          {analytics.mostConnectedCharacter.connections} connections
                        </div>
                      </Card>
                    </>
                  )
                })()}
              </div>
            )}

            {/* View Content */}
            {viewMode === 'grid' && (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {filteredRelationships.map(relationship => (
                  <RelationshipCard
                    key={relationship.id}
                    relationship={relationship}
                    onEdit={(rel) => {
                      console.log('🎯 CARD CLICK: Opening canvas for:', rel.name)
                      // Always open canvas for any relationship
                      setRelationshipName(rel.name)
                      setEditingRelationship(rel)
                      setShowCanvas(true)
                    }}
                    onDelete={handleDeleteRelationship}
                  />
                ))}
              </div>
            )}

            {viewMode === 'flowchart' && (
              <FlowchartView 
                relationships={filteredRelationships} 
                characters={characters}
                onCreateRelationship={handleQuickConnect}
              />
            )}

            {viewMode === 'network' && (
              <NetworkView 
                relationships={filteredRelationships} 
                characters={characters}
                networkData={generateNetworkData()}
              />
            )}

            {viewMode === 'matrix' && (
              <MatrixView 
                characters={characters} 
                relationships={relationships}
                matrix={generateMatrix()}
              />
            )}

            {viewMode === 'timeline' && (
              <TimelineView relationships={filteredRelationships} />
            )}
          </>
        )}

        <Dialog open={showCreateDialog} onOpenChange={(open) => {
          setShowCreateDialog(open)
          if (!open) {
            setEditingRelationship(null)
            resetForm()
            onClearSelection?.()
          }
        }}>
          <DialogContent className="!max-w-none w-[90vw] max-h-[90vh] overflow-y-auto bg-white border-rose-200 shadow-2xl rounded-3xl">
            <DialogHeader className="pb-6 border-b border-rose-100">
              <DialogTitle className="text-2xl font-bold bg-gradient-to-r from-rose-600 to-pink-600 bg-clip-text text-transparent flex items-center gap-3">
                <div className="w-8 h-8 rounded-full bg-gradient-to-r from-rose-500 to-pink-500 flex items-center justify-center">
                  <Heart className="w-4 h-4 text-white" />
                </div>
                {editingRelationship ? 'Edit Relationship' : 'Create New Relationship'}
              </DialogTitle>
              <DialogDescription className="text-gray-600 mt-2 text-base">
                Define the connection, dynamics, and story arc between two characters to bring depth to your story.
              </DialogDescription>
            </DialogHeader>

            <Tabs value={activeTab} onValueChange={(value) => setActiveTab(value as any)} className="w-full mt-6">
              <TabsList className="grid w-full grid-cols-4 bg-rose-50 border border-rose-200 rounded-2xl p-1 h-14">
                <TabsTrigger 
                  value="overview" 
                  className="rounded-xl data-[state=active]:bg-white data-[state=active]:text-rose-600 data-[state=active]:shadow-md font-medium transition-all duration-300"
                >
                  <User className="w-4 h-4 mr-2" />
                  Overview
                </TabsTrigger>
                <TabsTrigger 
                  value="dynamics" 
                  className="rounded-xl data-[state=active]:bg-white data-[state=active]:text-rose-600 data-[state=active]:shadow-md font-medium transition-all duration-300"
                >
                  <Activity className="w-4 h-4 mr-2" />
                  Dynamics
                </TabsTrigger>
                <TabsTrigger 
                  value="timeline" 
                  className="rounded-xl data-[state=active]:bg-white data-[state=active]:text-rose-600 data-[state=active]:shadow-md font-medium transition-all duration-300"
                >
                  <Calendar className="w-4 h-4 mr-2" />
                  Timeline
                </TabsTrigger>
                <TabsTrigger 
                  value="analysis" 
                  className="rounded-xl data-[state=active]:bg-white data-[state=active]:text-rose-600 data-[state=active]:shadow-md font-medium transition-all duration-300"
                >
                  <BarChart3 className="w-4 h-4 mr-2" />
                  Analysis
                </TabsTrigger>
              </TabsList>

              {/* Overview Tab */}
              <TabsContent value="overview" className="space-y-8 py-6">
                {/* Character Selection */}
                <div className="bg-white rounded-2xl p-6 border border-rose-100 shadow-sm">
                  <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <Users className="w-5 h-5 text-rose-500" />
                    Characters
                  </h3>
                  <div className="grid grid-cols-2 gap-6">
                    <div>
                      <Label htmlFor="character_1" className="text-sm font-medium text-gray-700 mb-2 block">First Character</Label>
                      <EnhancedSelect value={formData.character_1_id} onValueChange={(value: string) => 
                        setFormData(prev => ({ ...prev, character_1_id: value }))
                      }>
                          {characters.map(character => (
                            <EnhancedSelectItem key={character.id} value={character.id}>
                              <div className="flex items-center gap-3">
                                <div className="w-8 h-8 bg-rose-100 rounded-full flex items-center justify-center text-sm font-medium text-rose-700">
                                  {character.name.charAt(0).toUpperCase()}
                                </div>
                                {character.name}
                              </div>
                            </EnhancedSelectItem>
                          ))}
                      </EnhancedSelect>
                    </div>
                    <div>
                      <Label htmlFor="character_2" className="text-sm font-medium text-gray-700 mb-2 block">Second Character</Label>
                      <EnhancedSelect value={formData.character_2_id} onValueChange={(value: string) => 
                        setFormData(prev => ({ ...prev, character_2_id: value }))
                      }>
                          {characters.map(character => (
                            <EnhancedSelectItem key={character.id} value={character.id}>
                              <div className="flex items-center gap-3">
                                <div className="w-8 h-8 bg-rose-100 rounded-full flex items-center justify-center text-sm font-medium text-rose-700">
                                  {character.name.charAt(0).toUpperCase()}
                                </div>
                                {character.name}
                              </div>
                            </EnhancedSelectItem>
                          ))}
                      </EnhancedSelect>
                    </div>
                  </div>
                </div>

                {/* Basic Info */}
                <div className="bg-white rounded-2xl p-6 border border-rose-100 shadow-sm space-y-6">
                  <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <Heart className="w-5 h-5 text-rose-500" />
                    Basic Information
                  </h3>
                  <div>
                    <Label htmlFor="name" className="text-sm font-medium text-gray-700 mb-2 block">Relationship Name (Optional)</Label>
                    <EnhancedInput
                      id="name"
                      value={formData.name}
                      onChange={(e: React.ChangeEvent<HTMLInputElement>) => setFormData(prev => ({ ...prev, name: e.target.value }))}
                      placeholder="Auto-generated if left blank"
                      className="h-12"
                    />
                  </div>

                  <div>
                    <Label htmlFor="description" className="text-sm font-medium text-gray-700 mb-2 block">Description</Label>
                    <EnhancedTextarea
                      id="description"
                      value={formData.description}
                      onChange={(e: React.ChangeEvent<HTMLTextAreaElement>) => setFormData(prev => ({ ...prev, description: e.target.value }))}
                      placeholder="Describe the nature of this relationship..."
                      rows={3}
                      className="resize-none"
                    />
                  </div>
                </div>

                {/* Type and Status */}
                <div className="bg-white rounded-2xl p-6 border border-rose-100 shadow-sm">
                  <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <Settings className="w-5 h-5 text-rose-500" />
                    Settings & Status
                  </h3>
                  <div className="grid grid-cols-3 gap-6">
                    <div>
                      <Label htmlFor="type" className="text-sm font-medium text-gray-700 mb-2 block">Relationship Type</Label>
                      <EnhancedSelect value={formData.type} onValueChange={(value: string) => 
                        setFormData(prev => ({ ...prev, type: value }))
                      }>
                          {RELATIONSHIP_TYPES.map(type => (
                            <EnhancedSelectItem key={type.value} value={type.value}>
                              <div className="flex items-center gap-2">
                                <type.icon className="w-4 h-4" />
                                {type.label}
                              </div>
                            </EnhancedSelectItem>
                          ))}
                      </EnhancedSelect>
                    </div>
                    <div>
                      <Label htmlFor="status" className="text-sm font-medium text-gray-700 mb-2 block">Status</Label>
                      <EnhancedSelect value={formData.status} onValueChange={(value: string) => 
                        setFormData(prev => ({ ...prev, status: value }))
                      }>
                          {RELATIONSHIP_STATUS.map(status => (
                            <EnhancedSelectItem key={status.value} value={status.value}>
                              {status.label}
                            </EnhancedSelectItem>
                          ))}
                      </EnhancedSelect>
                    </div>
                    <div>
                      <Label htmlFor="story_importance" className="text-sm font-medium text-gray-700 mb-2 block">Story Importance</Label>
                      <EnhancedSelect value={formData.story_importance} onValueChange={(value: string) => 
                        setFormData(prev => ({ ...prev, story_importance: value as any }))
                      }>
                          {STORY_IMPORTANCE.map(importance => (
                            <EnhancedSelectItem key={importance.value} value={importance.value}>
                              <div className="flex items-center gap-2">
                                <div className={`w-2 h-2 rounded-full bg-${importance.color}-500`}></div>
                                {importance.label}
                              </div>
                            </EnhancedSelectItem>
                          ))}
                      </EnhancedSelect>
                    </div>
                  </div>

                  {/* Power Balance */}
                  <div className="mt-6">
                    <Label htmlFor="power_balance" className="text-sm font-medium text-gray-700 mb-2 block">Power Balance</Label>
                    <EnhancedSelect value={formData.power_balance} onValueChange={(value: string) => 
                      setFormData(prev => ({ ...prev, power_balance: value as any }))
                    }>
                        {POWER_BALANCE_OPTIONS.map(option => (
                          <EnhancedSelectItem key={option.value} value={option.value}>
                            <div>
                              <div className="font-medium">{option.label}</div>
                              <div className="text-sm text-gray-500">{option.description}</div>
                            </div>
                          </EnhancedSelectItem>
                        ))}
                    </EnhancedSelect>
                  </div>
                </div>
              </TabsContent>

              {/* Dynamics Tab */}
              <TabsContent value="dynamics" className="space-y-6 py-4">
                {/* Relationship Metrics */}
                <div className="grid grid-cols-2 gap-6">
                  {/* Left Column */}
                  <div className="space-y-4">
                    {/* Tension Level */}
                    <div>
                      <Label htmlFor="tension_level">Tension Level (0-10)</Label>
                      <Input
                        id="tension_level"
                        type="range"
                        min="0"
                        max="10"
                        value={formData.tension_level}
                        onChange={(e) => setFormData(prev => ({ ...prev, tension_level: parseInt(e.target.value) }))}
                        className="mt-2"
                      />
                      <div className="flex justify-between text-sm text-gray-500 mt-1">
                        <span>Peaceful</span>
                        <span className="font-medium text-red-500">{formData.tension_level}/10</span>
                        <span>Explosive</span>
                      </div>
                    </div>

                    {/* Trust Level */}
                    <div>
                      <Label htmlFor="trust_level">Trust Level (0-10)</Label>
                      <Input
                        id="trust_level"
                        type="range"
                        min="0"
                        max="10"
                        value={formData.trust_level}
                        onChange={(e) => setFormData(prev => ({ ...prev, trust_level: parseInt(e.target.value) }))}
                        className="mt-2"
                      />
                      <div className="flex justify-between text-sm text-gray-500 mt-1">
                        <span>None</span>
                        <span className="font-medium text-blue-500">{formData.trust_level}/10</span>
                        <span>Complete</span>
                      </div>
                    </div>

                    {/* Respect Level */}
                    <div>
                      <Label htmlFor="respect_level">Respect Level (0-10)</Label>
                      <Input
                        id="respect_level"
                        type="range"
                        min="0"
                        max="10"
                        value={formData.respect_level}
                        onChange={(e) => setFormData(prev => ({ ...prev, respect_level: parseInt(e.target.value) }))}
                        className="mt-2"
                      />
                      <div className="flex justify-between text-sm text-gray-500 mt-1">
                        <span>Disdain</span>
                        <span className="font-medium text-green-500">{formData.respect_level}/10</span>
                        <span>Admiration</span>
                      </div>
                    </div>
                  </div>

                  {/* Right Column */}
                  <div className="space-y-4">
                    {/* Intimacy Level */}
                    <div>
                      <Label htmlFor="intimacy_level">Intimacy Level (0-10)</Label>
                      <Input
                        id="intimacy_level"
                        type="range"
                        min="0"
                        max="10"
                        value={formData.intimacy_level}
                        onChange={(e) => setFormData(prev => ({ ...prev, intimacy_level: parseInt(e.target.value) }))}
                        className="mt-2"
                      />
                      <div className="flex justify-between text-sm text-gray-500 mt-1">
                        <span>Strangers</span>
                        <span className="font-medium text-purple-500">{formData.intimacy_level}/10</span>
                        <span>Soul Mates</span>
                      </div>
                    </div>

                    {/* Dependency Level */}
                    <div>
                      <Label htmlFor="dependency_level">Dependency Level (0-10)</Label>
                      <Input
                        id="dependency_level"
                        type="range"
                        min="0"
                        max="10"
                        value={formData.dependency_level}
                        onChange={(e) => setFormData(prev => ({ ...prev, dependency_level: parseInt(e.target.value) }))}
                        className="mt-2"
                      />
                      <div className="flex justify-between text-sm text-gray-500 mt-1">
                        <span>Independent</span>
                        <span className="font-medium text-orange-500">{formData.dependency_level}/10</span>
                        <span>Codependent</span>
                      </div>
                    </div>

                    {/* Strength (overall) */}
                    <div>
                      <Label htmlFor="strength">Relationship Strength (1-10)</Label>
                      <Input
                        id="strength"
                        type="range"
                        min="1"
                        max="10"
                        value={formData.strength}
                        onChange={(e) => setFormData(prev => ({ ...prev, strength: parseInt(e.target.value) }))}
                        className="mt-2"
                      />
                      <div className="flex justify-between text-sm text-gray-500 mt-1">
                        <span>Weak</span>
                        <span className="font-medium">{formData.strength}/10</span>
                        <span>Unbreakable</span>
                      </div>
                    </div>
                  </div>
                </div>

                <Separator />

                {/* Dynamics */}
                <div>
                  <Label>Relationship Dynamics</Label>
                  <div className="grid grid-cols-4 gap-2 mt-2">
                    {RELATIONSHIP_DYNAMICS.map(dynamic => (
                      <label key={dynamic} className="flex items-center space-x-2 text-sm">
                        <input
                          type="checkbox"
                          checked={formData.dynamics.includes(dynamic)}
                          onChange={(e) => {
                            if (e.target.checked) {
                              setFormData(prev => ({ 
                                ...prev, 
                                dynamics: [...prev.dynamics, dynamic] 
                              }))
                            } else {
                              setFormData(prev => ({ 
                                ...prev, 
                                dynamics: prev.dynamics.filter(d => d !== dynamic) 
                              }))
                            }
                          }}
                          className="rounded border-gray-300"
                        />
                        <span>{dynamic.replace('_', ' ')}</span>
                      </label>
                    ))}
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  {/* Conflict Sources */}
                  <div>
                    <Label>Sources of Conflict</Label>
                    <div className="grid grid-cols-2 gap-2 mt-2">
                      {CONFLICT_SOURCES.map(source => (
                        <label key={source} className="flex items-center space-x-2 text-sm">
                          <input
                            type="checkbox"
                            checked={formData.conflict_sources.includes(source)}
                            onChange={(e) => {
                              if (e.target.checked) {
                                setFormData(prev => ({ 
                                  ...prev, 
                                  conflict_sources: [...prev.conflict_sources, source] 
                                }))
                              } else {
                                setFormData(prev => ({ 
                                  ...prev, 
                                  conflict_sources: prev.conflict_sources.filter(s => s !== source) 
                                }))
                              }
                            }}
                            className="rounded border-gray-300"
                          />
                          <span>{source.replace('_', ' ')}</span>
                        </label>
                      ))}
                    </div>
                  </div>

                  {/* Bonding Factors */}
                  <div>
                    <Label>Bonding Factors</Label>
                    <div className="grid grid-cols-2 gap-2 mt-2">
                      {BONDING_FACTORS.map(factor => (
                        <label key={factor} className="flex items-center space-x-2 text-sm">
                          <input
                            type="checkbox"
                            checked={formData.bonding_factors.includes(factor)}
                            onChange={(e) => {
                              if (e.target.checked) {
                                setFormData(prev => ({ 
                                  ...prev, 
                                  bonding_factors: [...prev.bonding_factors, factor] 
                                }))
                              } else {
                                setFormData(prev => ({ 
                                  ...prev, 
                                  bonding_factors: prev.bonding_factors.filter(f => f !== factor) 
                                }))
                              }
                            }}
                            className="rounded border-gray-300"
                          />
                          <span>{factor.replace('_', ' ')}</span>
                        </label>
                      ))}
                    </div>
                  </div>
                </div>
              </TabsContent>

              {/* Timeline Tab */}
              <TabsContent value="timeline" className="space-y-6 py-4">
                <div className="text-center py-12">
                  <Calendar className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                  <p className="text-gray-600 text-lg mb-2">Timeline Events</p>
                  <p className="text-gray-500 text-sm mb-6">
                    Track how this relationship develops over time
                  </p>
                  <Button variant="outline">
                    <Plus className="w-4 h-4 mr-2" />
                    Add Timeline Event
                  </Button>
                </div>
              </TabsContent>

              {/* Analysis Tab */}
              <TabsContent value="analysis" className="space-y-6 py-4">
                <div className="space-y-4">
                  <div>
                    <Label htmlFor="relationship_goals">Relationship Goals & Arc</Label>
                    <Textarea
                      id="relationship_goals"
                      value={formData.relationship_goals}
                      onChange={(e) => setFormData(prev => ({ ...prev, relationship_goals: e.target.value }))}
                      placeholder="Where should this relationship go? What's the intended arc?"
                      rows={3}
                    />
                  </div>

                  <div>
                    <Label htmlFor="history">Relationship History</Label>
                    <Textarea
                      id="history"
                      value={formData.history}
                      onChange={(e) => setFormData(prev => ({ ...prev, history: e.target.value }))}
                      placeholder="How did this relationship develop over time?"
                      rows={3}
                    />
                  </div>

                  <div>
                    <Label htmlFor="current_state">Current State</Label>
                    <Textarea
                      id="current_state"
                      value={formData.current_state}
                      onChange={(e) => setFormData(prev => ({ ...prev, current_state: e.target.value }))}
                      placeholder="What's the current state of this relationship?"
                      rows={2}
                    />
                  </div>

                  <div>
                    <Label htmlFor="notes">Additional Notes</Label>
                    <Textarea
                      id="notes"
                      value={formData.notes}
                      onChange={(e) => setFormData(prev => ({ ...prev, notes: e.target.value }))}
                      placeholder="Any other notes about this relationship..."
                      rows={2}
                    />
                  </div>
                </div>
              </TabsContent>
            </Tabs>

            <div className="flex justify-end gap-3 pt-6 border-t border-rose-100 bg-gradient-to-r from-rose-50/50 to-pink-50/50 -mx-6 -mb-6 px-6 pb-6 mt-6 rounded-b-3xl">
              <Button 
                variant="outline" 
                onClick={() => {
                  setShowCreateDialog(false)
                  setEditingRelationship(null)
                  resetForm()
                  onClearSelection?.()
                }}
                className="border-gray-200 text-gray-600 hover:bg-gray-50 h-12 px-6 rounded-xl font-medium"
              >
                <X className="w-4 h-4 mr-2" />
                Cancel
              </Button>
              <Button 
                onClick={handleCreateRelationship}
                className="bg-gradient-to-r from-rose-500 to-pink-600 hover:from-rose-600 hover:to-pink-700 text-white shadow-lg hover:shadow-xl h-12 px-8 rounded-xl font-medium transition-all duration-300"
                disabled={!formData.character_1_id || !formData.character_2_id}
              >
                <Save className="w-4 h-4 mr-2" />
                {editingRelationship ? 'Update' : 'Create'} Relationship
              </Button>
            </div>
          </DialogContent>
        </Dialog>

        {/* Quick Connect Dialog */}
        <Dialog open={showQuickConnect} onOpenChange={setShowQuickConnect}>
          <DialogContent className="max-w-lg bg-white border-rose-200 shadow-2xl rounded-3xl">
            <DialogHeader className="pb-6 border-b border-rose-100">
              <DialogTitle className="text-xl font-bold bg-gradient-to-r from-rose-600 to-pink-600 bg-clip-text text-transparent flex items-center gap-3">
                <div className="w-8 h-8 rounded-full bg-gradient-to-r from-rose-500 to-pink-500 flex items-center justify-center">
                  <Zap className="w-4 h-4 text-white" />
                </div>
                Quick Connect Characters
              </DialogTitle>
              <DialogDescription className="text-gray-600 mt-2">
                Create a relationship between two characters instantly
              </DialogDescription>
            </DialogHeader>

            <div className="space-y-6 py-4">
              {/* Character Selection */}
              <div className="bg-white rounded-2xl p-6 border border-rose-100 shadow-sm">
                <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                  <Users className="w-5 h-5 text-rose-500" />
                  Select Characters
                </h3>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">First Character</label>
                    <EnhancedSelect value={quickConnectChar1} onValueChange={setQuickConnectChar1}>
                      {characters.map(character => (
                        <EnhancedSelectItem key={character.id} value={character.id}>
                          <div className="flex items-center gap-2">
                            <div className="w-6 h-6 bg-rose-100 rounded-full flex items-center justify-center text-xs font-medium text-rose-700">
                              {character.name.charAt(0).toUpperCase()}
                            </div>
                            {character.name}
                          </div>
                        </EnhancedSelectItem>
                      ))}
                  </EnhancedSelect>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Second Character</label>
                  <EnhancedSelect value={quickConnectChar2} onValueChange={setQuickConnectChar2}>
                      {characters.filter(c => c.id !== quickConnectChar1).map(character => (
                        <EnhancedSelectItem key={character.id} value={character.id}>
                          <div className="flex items-center gap-2">
                            <div className="w-6 h-6 bg-rose-100 rounded-full flex items-center justify-center text-xs font-medium text-rose-700">
                              {character.name.charAt(0).toUpperCase()}
                            </div>
                            {character.name}
                          </div>
                        </EnhancedSelectItem>
                      ))}
                  </EnhancedSelect>
                </div>
              </div>
              </div>

              {/* Relationship Type */}
              <div className="bg-white rounded-2xl p-6 border border-rose-100 shadow-sm">
                <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                  <Heart className="w-5 h-5 text-rose-500" />
                  Relationship Details
                </h3>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Relationship Type</label>
                    <EnhancedSelect value={quickConnectType} onValueChange={setQuickConnectType}>
                    <EnhancedSelectItem value="friendship">
                      <div className="flex items-center gap-2">
                        <Users className="w-4 h-4 text-green-500" />
                        Friendship
                      </div>
                    </EnhancedSelectItem>
                    <EnhancedSelectItem value="romance">
                      <div className="flex items-center gap-2">
                        <Heart className="w-4 h-4 text-rose-500" />
                        Romance
                      </div>
                    </EnhancedSelectItem>
                    <EnhancedSelectItem value="family">
                      <div className="flex items-center gap-2">
                        <Home className="w-4 h-4 text-blue-500" />
                        Family
                      </div>
                    </EnhancedSelectItem>
                    <EnhancedSelectItem value="rivalry">
                      <div className="flex items-center gap-2">
                        <Swords className="w-4 h-4 text-orange-500" />
                        Rivalry
                      </div>
                    </EnhancedSelectItem>
                    <EnhancedSelectItem value="conflict">
                      <div className="flex items-center gap-2">
                        <Shield className="w-4 h-4 text-red-500" />
                        Conflict
                      </div>
                    </EnhancedSelectItem>
                    <EnhancedSelectItem value="mentor">
                      <div className="flex items-center gap-2">
                        <BookOpen className="w-4 h-4 text-purple-500" />
                        Mentor
                      </div>
                    </EnhancedSelectItem>
                </EnhancedSelect>
              </div>

              {/* Intensity Slider */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Relationship Intensity: {quickConnectIntensity}/10
                </label>
                <Input
                  type="range"
                  min={1}
                  max={10}
                  step={1}
                  value={quickConnectIntensity}
                  onChange={(e) => setQuickConnectIntensity(parseInt(e.target.value))}
                  className="w-full"
                />
                <div className="flex justify-between text-xs text-gray-500 mt-1">
                  <span>Weak</span>
                  <span>Strong</span>
                </div>
              </div>
              </div>
            </div>
            </div>

            <div className="flex justify-end gap-3 pt-6 border-t border-rose-100 bg-gradient-to-r from-rose-50/50 to-pink-50/50 -mx-6 -mb-6 px-6 pb-6 mt-6 rounded-b-3xl">
              <Button 
                variant="outline" 
                onClick={() => setShowQuickConnect(false)}
                className="border-gray-200 text-gray-600 hover:bg-gray-50 h-12 px-6 rounded-xl font-medium"
              >
                <X className="w-4 h-4 mr-2" />
                Cancel
              </Button>
              <Button 
                onClick={() => handleQuickConnect()}
                className="bg-gradient-to-r from-rose-500 to-pink-600 hover:from-rose-600 hover:to-pink-700 text-white shadow-lg hover:shadow-xl h-12 px-8 rounded-xl font-medium transition-all duration-300"
                disabled={!quickConnectChar1 || !quickConnectChar2}
              >
                <Zap className="w-4 h-4 mr-2" />
                Quick Connect
              </Button>
            </div>
          </DialogContent>
        </Dialog>
      </div>
    </div>
  )
}

// Canvas-based Relationship Editor Component
interface CanvasNode {
  id: string
  type: 'character' | 'location' | 'item' | 'concept'
  name: string
  x: number
  y: number
  width: number
  height: number
  color?: string
  imageUrl?: string
}

interface CanvasConnection {
  id: string
  fromNodeId: string
  toNodeId: string
  label: string
  type: string
  color: string
  textColor?: string
  hasArrow: boolean
  hasReverseArrow?: boolean
  arrowSize?: number
  reverseArrowSize?: number
  arrowColor?: string
  reverseArrowColor?: string
  isDirectional: boolean
  strokeWidth?: number
  strokeDasharray?: string | null
}

interface RelationshipCanvasProps {
  relationshipName: string
  characters: Character[]
  existingRelationship?: Relationship | null
  onClose: () => void
  onSave: (data: { nodes: CanvasNode[], connections: CanvasConnection[] }) => void
}

const RelationshipCanvas: React.FC<RelationshipCanvasProps> = ({
  relationshipName,
  characters,
  existingRelationship,
  onClose,
  onSave
}) => {
  const canvasRef = useRef<HTMLDivElement>(null)
  const [nodes, setNodes] = useState<CanvasNode[]>([])
  const [connections, setConnections] = useState<CanvasConnection[]>([])
  const [selectedNode, setSelectedNode] = useState<string | null>(null)
  const [selectedConnection, setSelectedConnection] = useState<string | null>(null)
  const [editingConnection, setEditingConnection] = useState<string | null>(null)
  const [isConnecting, setIsConnecting] = useState(false)
  const [connectionStart, setConnectionStart] = useState<string | null>(null)
  const [isDragging, setIsDragging] = useState(false)
  const [dragStart, setDragStart] = useState({ x: 0, y: 0 })
  const [canvasOffset, setCanvasOffset] = useState({ x: 0, y: 0 })
  const [scale, setScale] = useState(1)
  const [showElementsPanel, setShowElementsPanel] = useState(true)

  // Initialize canvas with existing relationship data if available
  useEffect(() => {
    if (existingRelationship && existingRelationship.attributes?.canvas_data) {
      console.log('🎯 INITIALIZING CANVAS with existing data:', existingRelationship.attributes.canvas_data)
      const canvasData = existingRelationship.attributes.canvas_data
      
      if (canvasData.nodes) {
        setNodes(canvasData.nodes)
      }
      if (canvasData.connections) {
        // Add backward compatibility for existing connections
        const connectionsWithDefaults = canvasData.connections.map((conn: any) => ({
          ...conn,
          hasReverseArrow: conn.hasReverseArrow ?? false,
          arrowSize: conn.arrowSize ?? 12,
          reverseArrowSize: conn.reverseArrowSize ?? 12,
          arrowColor: conn.arrowColor ?? conn.color,
          reverseArrowColor: conn.reverseArrowColor ?? conn.color,
          strokeWidth: conn.strokeWidth ?? 2,
          // Set label from type if it's a predefined relationship and label is generic
          label: (conn.type !== 'custom' && (!conn.label || conn.label === 'New Relationship')) ? conn.type : conn.label
        }))
        setConnections(connectionsWithDefaults)
      }
    } else {
      console.log('🎯 CANVAS: No existing data, starting empty')
    }
  }, [existingRelationship])

  // Add character to canvas
  const addCharacterToCanvas = (character: Character) => {
    const newNode: CanvasNode = {
      id: character.id,
      type: 'character',
      name: character.name,
      x: Math.random() * 400 + 100,
      y: Math.random() * 300 + 100,
      width: 150,
      height: 80,
      color: '#f43f5e',
      imageUrl: undefined
    }
    setNodes(prev => [...prev, newNode])
  }

  // Handle node dragging
  const handleNodeMouseDown = (nodeId: string, e: React.MouseEvent) => {
    e.stopPropagation()
    setSelectedNode(nodeId)
    setIsDragging(true)
    setDragStart({ x: e.clientX, y: e.clientY })
  }

  const handleMouseMove = (e: React.MouseEvent) => {
    if (isDragging && selectedNode) {
      const deltaX = e.clientX - dragStart.x
      const deltaY = e.clientY - dragStart.y
      
      setNodes(prev => prev.map(node => 
        node.id === selectedNode 
          ? { ...node, x: node.x + deltaX / scale, y: node.y + deltaY / scale }
          : node
      ))
      
      setDragStart({ x: e.clientX, y: e.clientY })
    }
  }

  const handleMouseUp = () => {
    setIsDragging(false)
    // setSelectedNode(null) // Commented out to preserve node selection
  }

  // Connection creation
  const startConnection = (nodeId: string) => {
    setIsConnecting(true)
    setConnectionStart(nodeId)
  }

  const completeConnection = (endNodeId: string) => {
    if (connectionStart && connectionStart !== endNodeId) {
      const newConnection: CanvasConnection = {
        id: `${connectionStart}-${endNodeId}-${Date.now()}`,
        fromNodeId: connectionStart,
        toNodeId: endNodeId,
        label: 'New Relationship',
        type: 'friendship',
        color: '#10b981',
        hasArrow: true,
        isDirectional: false
      }
      setConnections(prev => [...prev, newConnection])
    }
    setIsConnecting(false)
    setConnectionStart(null)
  }

  // Canvas controls
  const zoomIn = () => setScale(prev => Math.min(prev * 1.2, 3))
  const zoomOut = () => setScale(prev => Math.max(prev / 1.2, 0.3))
  const resetZoom = () => setScale(1)
  const fitToScreen = () => {
    // Implementation for fitting all nodes to screen
    setScale(1)
    setCanvasOffset({ x: 0, y: 0 })
  }

  // Get connection path
  const getConnectionPath = (connection: CanvasConnection) => {
    const fromNode = nodes.find(n => n.id === connection.fromNodeId)
    const toNode = nodes.find(n => n.id === connection.toNodeId)
    
    if (!fromNode || !toNode) return ''
    
    const fromX = fromNode.x + fromNode.width / 2
    const fromY = fromNode.y + fromNode.height / 2
    const toX = toNode.x + toNode.width / 2
    const toY = toNode.y + toNode.height / 2
    
    return `M ${fromX} ${fromY} L ${toX} ${toY}`
  }

  // Save canvas data
  const handleSave = () => {
    onSave({ nodes, connections })
  }

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex">
      {/* Elements Panel */}
      {showElementsPanel && (
        <div className="w-80 bg-white shadow-xl overflow-y-auto">
          <div className="p-6 border-b">
            <h3 className="text-lg font-semibold text-gray-900">Add Elements</h3>
            <p className="text-sm text-gray-600 mt-1">Drag characters and elements to the canvas</p>
          </div>
          
          <div className="p-4 space-y-4">
            <div>
              <h4 className="font-medium text-gray-900 mb-3">Characters</h4>
              <div className="space-y-2">
                {characters.map(character => (
                  <div
                    key={character.id}
                    onClick={() => addCharacterToCanvas(character)}
                    className="flex items-center gap-3 p-3 rounded-lg border border-gray-200 hover:border-rose-300 hover:bg-rose-50 cursor-pointer transition-colors"
                  >
                    <div className="w-10 h-10 bg-rose-100 rounded-full flex items-center justify-center text-sm font-medium text-rose-700">
                      {character.name.charAt(0).toUpperCase()}
                    </div>
                    <span className="font-medium text-gray-900">{character.name}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Main Canvas Area */}
      <div className="flex-1 flex flex-col">
        {/* Header */}
        <div className="bg-white border-b px-6 py-4 flex items-center justify-between">
          <div>
            <h2 className="text-xl font-semibold text-gray-900">{relationshipName}</h2>
            <p className="text-sm text-gray-600">Visual Relationship Editor</p>
          </div>
          
          <div className="flex items-center gap-3">
            <Button
              variant="outline"
              onClick={() => setShowElementsPanel(!showElementsPanel)}
              className="border-gray-300"
            >
              <Layers className="w-4 h-4 mr-2" />
              {showElementsPanel ? 'Hide' : 'Show'} Elements
            </Button>
            
            <div className="flex items-center gap-1 border rounded-lg">
              <Button variant="ghost" size="sm" onClick={zoomOut}>
                <span className="text-lg">-</span>
              </Button>
              <span className="px-3 text-sm font-medium">{Math.round(scale * 100)}%</span>
              <Button variant="ghost" size="sm" onClick={zoomIn}>
                <span className="text-lg">+</span>
              </Button>
            </div>
            
            <Button variant="outline" onClick={resetZoom}>
              <RotateCcw className="w-4 h-4" />
            </Button>
            
            <Button variant="outline" onClick={fitToScreen}>
              <Grid className="w-4 h-4" />
            </Button>
            
            <Button onClick={handleSave} className="bg-green-600 hover:bg-green-700 text-white">
              <Save className="w-4 h-4 mr-2" />
              Save
            </Button>
            
            <Button variant="outline" onClick={onClose}>
              <X className="w-4 h-4" />
            </Button>
          </div>
        </div>

        {/* Canvas */}
        <div className="flex-1 relative overflow-hidden bg-gray-50">
          <div
            ref={canvasRef}
            className="w-full h-full relative cursor-move"
            style={{
              transform: `scale(${scale}) translate(${canvasOffset.x}px, ${canvasOffset.y}px)`
            }}
            onMouseMove={handleMouseMove}
            onMouseUp={handleMouseUp}
          >
            {/* Grid Background */}
            <div className="absolute inset-0 opacity-20">
              <svg width="100%" height="100%">
                <defs>
                  <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                    <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e5e7eb" strokeWidth="1"/>
                  </pattern>
                </defs>
                <rect width="100%" height="100%" fill="url(#grid)" />
              </svg>
            </div>

            {/* Connections */}
            <svg 
              key={`connections-${connections.length}-${connections.map(c => `${c.id}-${c.hasArrow}-${c.hasReverseArrow}`).join('-')}`}
              className="absolute inset-0 w-full h-full pointer-events-none"
            >
              <defs>
                {/* Single arrow marker that we'll reuse */}
                <marker
                  id="arrowhead"
                  markerWidth="10"
                  markerHeight="10" 
                  refX="9"
                  refY="5"
                  orient="auto"
                  markerUnits="strokeWidth"
                >
                  <path
                    d="M 0,0 L 0,10 L 10,5 z"
                    fill="currentColor"
                  />
                </marker>
                {/* Reverse arrow marker */}
                <marker
                  id="arrowhead-reverse"
                  markerWidth="10"
                  markerHeight="10"
                  refX="1"
                  refY="5"
                  orient="auto"
                  markerUnits="strokeWidth"
                >
                  <path
                    d="M 10,0 L 10,10 L 0,5 z"
                    fill="currentColor"
                  />
                </marker>
              </defs>
              {connections.map(connection => (
                <g key={connection.id}>
                  <path
                    d={getConnectionPath(connection)}
                    stroke={connection.color}
                    strokeWidth={connection.strokeWidth || 3}
                    strokeDasharray={connection.strokeDasharray || undefined}
                    fill="none"
                    className="pointer-events-auto cursor-pointer hover:stroke-width-4"
                    markerEnd={connection.hasArrow ? "url(#arrowhead)" : undefined}
                    markerStart={connection.hasReverseArrow ? "url(#arrowhead-reverse)" : undefined}
                    onClick={() => setSelectedConnection(connection.id)}
                  />
                </g>
              ))}
            </svg>

            {/* Nodes */}
            {nodes.map(node => (
              <div
                key={node.id}
                className={cn(
                  "absolute bg-white rounded-xl shadow-lg border-2 cursor-move select-none",
                  selectedNode === node.id ? "border-rose-500" : "border-gray-200",
                  "hover:shadow-xl transition-shadow"
                )}
                style={{
                  left: node.x,
                  top: node.y,
                  width: node.width,
                  height: node.height
                }}
                onMouseDown={(e) => handleNodeMouseDown(node.id, e)}
                onClick={() => {
                  if (isConnecting) {
                    completeConnection(node.id)
                  } else {
                    setSelectedNode(node.id)
                  }
                }}
              >
                <div className="p-4 h-full flex items-center justify-center">
                  <div className="text-center">
                    <div className="w-8 h-8 bg-rose-100 rounded-full flex items-center justify-center text-sm font-medium text-rose-700 mx-auto mb-2">
                      {node.name.charAt(0).toUpperCase()}
                    </div>
                    <span className="text-sm font-medium text-gray-900">{node.name}</span>
                    <div className="text-xs text-gray-500 capitalize">{node.type}</div>
                  </div>
                </div>

                {/* Node Actions */}
                {selectedNode === node.id && (
                  <div className="absolute -top-2 -right-2 flex gap-1">
                    <Button
                      size="sm"
                      variant="outline"
                      className="w-6 h-6 p-0 bg-blue-500 hover:bg-blue-600 text-white border-blue-500"
                      onClick={(e) => {
                        e.stopPropagation()
                        startConnection(node.id)
                      }}
                    >
                      <Link2 className="w-3 h-3" />
                    </Button>
                    <Button
                      size="sm"
                      variant="outline"
                      className="w-6 h-6 p-0 bg-red-500 hover:bg-red-600 text-white border-red-500"
                      onClick={(e) => {
                        e.stopPropagation()
                        setNodes(prev => prev.filter(n => n.id !== node.id))
                        setConnections(prev => prev.filter(c => 
                          c.fromNodeId !== node.id && c.toNodeId !== node.id
                        ))
                      }}
                    >
                      <Trash2 className="w-3 h-3" />
                    </Button>
                  </div>
                )}
              </div>
            ))}

            {/* Connection Guide */}
            {isConnecting && (
              <div className="absolute top-4 left-4 bg-blue-100 text-blue-800 px-4 py-2 rounded-lg shadow">
                Click on another element to create a connection
              </div>
            )}
          </div>
        </div>

        {/* Connection Properties Panel */}
        {selectedConnection && (
          <div className="absolute bottom-4 right-4 w-80 bg-white rounded-xl shadow-xl border p-4">
            <h4 className="font-medium text-gray-900 mb-3">Connection Properties</h4>
            <div className="space-y-3">
              <div>
                <Label className="text-sm">Label</Label>
                <Input
                  value={connections.find(c => c.id === selectedConnection)?.label || ''}
                  onChange={(e) => {
                    setConnections(prev => prev.map(conn => 
                      conn.id === selectedConnection 
                        ? { ...conn, label: e.target.value }
                        : conn
                    ))
                  }}
                />
              </div>
              <div>
                <Label className="text-sm">Color</Label>
                <input
                  type="color"
                  value={connections.find(c => c.id === selectedConnection)?.color || '#10b981'}
                  onChange={(e) => {
                    setConnections(prev => prev.map(conn => 
                      conn.id === selectedConnection 
                        ? { ...conn, color: e.target.value }
                        : conn
                    ))
                  }}
                  className="w-full h-10 rounded border"
                />
              </div>
              <div className="flex justify-between">
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => {
                    setConnections(prev => prev.filter(c => c.id !== selectedConnection))
                    setSelectedConnection(null)
                  }}
                  className="text-red-600 border-red-200 hover:bg-red-50"
                >
                  Delete
                </Button>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setSelectedConnection(null)}
                >
                  Done
                </Button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}

// Inline Canvas Component for Main Content Area
const InlineRelationshipCanvas: React.FC<RelationshipCanvasProps> = ({
  relationshipName,
  characters,
  existingRelationship,
  onClose,
  onSave
}) => {
  const canvasRef = useRef<HTMLDivElement>(null)
  const [nodes, setNodes] = useState<CanvasNode[]>([])
  const [connections, setConnections] = useState<CanvasConnection[]>([])
  const [selectedNode, setSelectedNode] = useState<string | null>(null)
  const [selectedConnection, setSelectedConnection] = useState<string | null>(null)
  const [isConnecting, setIsConnecting] = useState(false)
  const [connectionStart, setConnectionStart] = useState<string | null>(null)
  const [isDragging, setIsDragging] = useState(false)
  const [dragStart, setDragStart] = useState({ x: 0, y: 0 })
  const [scale, setScale] = useState(1)
  const [showElementsPanel, setShowElementsPanel] = useState(true)

  // Initialize canvas with existing relationship data if available
  useEffect(() => {
    if (existingRelationship && existingRelationship.attributes?.canvas_data) {
      console.log('🎯 INLINE CANVAS: Initializing with existing data:', existingRelationship.attributes.canvas_data)
      const canvasData = existingRelationship.attributes.canvas_data
      
      if (canvasData.nodes) {
        setNodes(canvasData.nodes)
      }
      if (canvasData.connections) {
        setConnections(canvasData.connections)
      }
    } else {
      console.log('🎯 INLINE CANVAS: No existing data, starting empty')
    }
  }, [existingRelationship])

  // Clean up duplicate nodes
  useEffect(() => {
    setNodes(prev => {
      const uniqueNodes = prev.filter((node, index, self) => 
        index === self.findIndex(n => n.id === node.id)
      )
      if (uniqueNodes.length !== prev.length) {
        console.log('Removed duplicate nodes:', prev.length - uniqueNodes.length)
      }
      return uniqueNodes
    })
  }, [])

  // Add character to canvas
  const addCharacterToCanvas = (character: Character) => {
    // Check if character is already on canvas
    if (nodes.some(node => node.id === character.id)) {
      console.log('Character already on canvas:', character.name)
      return
    }

    const newNode: CanvasNode = {
      id: character.id,
      type: 'character',
      name: character.name,
      x: Math.random() * 400 + 100,
      y: Math.random() * 300 + 100,
      width: 150,
      height: 80,
      color: '#f43f5e'
    }
    console.log('Adding character to canvas:', character.name)
    setNodes(prev => [...prev, newNode])
  }

  // Handle node dragging
  const handleNodeMouseDown = (nodeId: string, e: React.MouseEvent) => {
    e.stopPropagation()
    setSelectedNode(nodeId)
    setIsDragging(true)
    setDragStart({ x: e.clientX, y: e.clientY })
  }

  const handleMouseMove = (e: React.MouseEvent) => {
    if (isDragging && selectedNode) {
      const deltaX = e.clientX - dragStart.x
      const deltaY = e.clientY - dragStart.y
      
      setNodes(prev => prev.map(node => 
        node.id === selectedNode 
          ? { ...node, x: node.x + deltaX / scale, y: node.y + deltaY / scale }
          : node
      ))
      
      setDragStart({ x: e.clientX, y: e.clientY })
    }
  }

  const handleMouseUp = () => {
    setIsDragging(false)
    // setSelectedNode(null) // Commented out to preserve node selection
  }

  // Connection creation
  const startConnection = (nodeId: string) => {
    setIsConnecting(true)
    setConnectionStart(nodeId)
  }

  const completeConnection = (endNodeId: string) => {
    if (connectionStart && connectionStart !== endNodeId) {
      const newConnection: CanvasConnection = {
        id: `${connectionStart}-${endNodeId}-${Date.now()}`,
        fromNodeId: connectionStart,
        toNodeId: endNodeId,
        label: 'New Relationship',
        type: 'friendship',
        color: '#10b981',
        hasArrow: true,
        isDirectional: false
      }
      setConnections(prev => [...prev, newConnection])
    }
    setIsConnecting(false)
    setConnectionStart(null)
  }

  // Canvas controls
  const zoomIn = () => setScale(prev => Math.min(prev * 1.2, 3))
  const zoomOut = () => setScale(prev => Math.max(prev / 1.2, 0.3))
  const resetZoom = () => setScale(1)

  // Get connection path
  const getConnectionPath = (connection: CanvasConnection) => {
    const fromNode = nodes.find(n => n.id === connection.fromNodeId)
    const toNode = nodes.find(n => n.id === connection.toNodeId)
    
    if (!fromNode || !toNode) return ''
    
    const fromX = fromNode.x + fromNode.width / 2
    const fromY = fromNode.y + fromNode.height / 2
    const toX = toNode.x + toNode.width / 2
    const toY = toNode.y + toNode.height / 2
    
    return `M ${fromX} ${fromY} L ${toX} ${toY}`
  }

  // Save canvas data
  const handleSave = () => {
    onSave({ nodes, connections })
  }

  return (
    <div className="flex h-full bg-gradient-to-br from-slate-50 to-gray-100 rounded-xl shadow-lg border border-gray-200/80 overflow-hidden">
      {/* Elements Panel */}
      {showElementsPanel && (
        <div className="w-80 bg-white/90 backdrop-blur-sm border-r border-gray-200/60 overflow-y-auto">
          <div className="p-4 border-b border-gray-200/60 bg-gradient-to-r from-blue-50 to-indigo-50">
            <h3 className="text-lg font-semibold text-gray-900 flex items-center">
              <Users className="w-5 h-5 mr-2 text-blue-600" />
              Add Elements
            </h3>
            <p className="text-sm text-gray-600 mt-1">Click characters to add them to the canvas</p>
          </div>
          
          <div className="p-4 space-y-4">
            <div>
              <h4 className="font-medium text-gray-900 mb-3 flex items-center">
                <UserCircle className="w-4 h-4 mr-2 text-gray-500" />
                Characters
              </h4>
              <div className="space-y-2">
                {characters.map(character => {
                  const isOnCanvas = nodes.some(node => node.id === character.id)
                  return (
                    <div
                      key={character.id}
                      onClick={() => addCharacterToCanvas(character)}
                      className={cn(
                        "group flex items-center gap-3 p-3 rounded-xl border transition-all duration-200",
                        isOnCanvas 
                          ? "border-green-300 bg-green-50/50 cursor-default" 
                          : "border-gray-200/60 hover:border-blue-300 hover:bg-gradient-to-r hover:from-blue-50/50 hover:to-indigo-50/50 cursor-pointer hover:shadow-sm hover:scale-[1.02]"
                      )}
                    >
                      <div className={cn(
                        "w-12 h-12 rounded-xl flex items-center justify-center text-sm font-semibold shadow-sm transition-shadow",
                        isOnCanvas
                          ? "bg-gradient-to-br from-green-100 to-emerald-100 text-green-700 group-hover:shadow-md"
                          : "bg-gradient-to-br from-blue-100 to-indigo-100 text-blue-700 group-hover:shadow-md"
                      )}>
                        {character.name.charAt(0).toUpperCase()}
                      </div>
                      <div className="flex-1">
                        <span className="font-medium text-gray-900 block">{character.name}</span>
                        <span className={cn(
                          "text-xs",
                          isOnCanvas ? "text-green-600" : "text-gray-500"
                        )}>
                          {isOnCanvas ? "On Canvas" : "Character"}
                        </span>
                      </div>
                      {isOnCanvas ? (
                        <CheckCircle className="w-4 h-4 text-green-500" />
                      ) : (
                        <Plus className="w-4 h-4 text-gray-400 group-hover:text-blue-500 transition-colors" />
                      )}
                    </div>
                  )
                })}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Main Canvas Area */}
      <div className="flex-1 flex flex-col">
        {/* Header */}
        <div className="bg-white/95 backdrop-blur-sm border-b border-gray-200/60 px-6 py-4 flex items-center justify-between shadow-sm">
          <div>
            <h2 className="text-xl font-bold text-gray-900 flex items-center">
              <Network className="w-6 h-6 mr-2 text-indigo-600" />
              {relationshipName}
            </h2>
            <p className="text-sm text-gray-600 flex items-center mt-1">
              <Palette className="w-4 h-4 mr-1" />
              Visual Relationship Editor
            </p>
          </div>
          
          <div className="flex items-center gap-2">
            <Button
              variant="outline"
              size="sm"
              onClick={() => setShowElementsPanel(!showElementsPanel)}
              className="border-gray-300 hover:border-indigo-300 hover:bg-indigo-50 transition-colors"
            >
              <Layers className="w-4 h-4 mr-2" />
              {showElementsPanel ? 'Hide Panel' : 'Show Panel'}
            </Button>
            
            <div className="flex items-center gap-0 border border-gray-200 rounded-xl bg-white shadow-sm">
              <Button 
                variant="ghost" 
                size="sm" 
                onClick={zoomOut} 
                className="px-3 rounded-l-xl hover:bg-gray-50"
                disabled={scale <= 0.3}
              >
                <ZoomOut className="w-4 h-4" />
              </Button>
              <div className="px-4 py-1.5 text-xs font-medium text-gray-700 border-x border-gray-200 bg-gray-50">
                {Math.round(scale * 100)}%
              </div>
              <Button 
                variant="ghost" 
                size="sm" 
                onClick={zoomIn} 
                className="px-3 rounded-r-xl hover:bg-gray-50"
                disabled={scale >= 3}
              >
                <ZoomIn className="w-4 h-4" />
              </Button>
            </div>
            
            <Button 
              variant="outline" 
              size="sm" 
              onClick={resetZoom}
              className="border-gray-300 hover:border-gray-400 hover:bg-gray-50"
            >
              <RotateCcw className="w-4 h-4" />
            </Button>
            
            <Button 
              onClick={handleSave} 
              size="sm" 
              className="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white shadow-sm hover:shadow-md transition-all duration-200"
            >
              <Save className="w-4 h-4 mr-2" />
              Save Canvas
            </Button>
            
            <Button 
              variant="outline" 
              size="sm" 
              onClick={onClose}
              className="border-gray-300 hover:border-red-300 hover:bg-red-50 hover:text-red-600"
            >
              <X className="w-4 h-4" />
            </Button>
          </div>
        </div>

        {/* Canvas */}
        <div className="flex-1 relative overflow-hidden bg-gradient-to-br from-gray-50 via-blue-50/20 to-indigo-50/30">
          <div
            ref={canvasRef}
            className="w-full h-full relative cursor-move"
            style={{
              transform: `scale(${scale})`,
              transformOrigin: 'center center'
            }}
            onMouseMove={handleMouseMove}
            onMouseUp={handleMouseUp}
            onClick={(e) => {
              // Clear selection if clicking on canvas background (not on nodes or buttons)
              const target = e.target as HTMLElement
              const isNode = target.closest('[data-node-id]')
              const isButton = target.closest('button')
              
              if (!isNode && !isButton) {
                setSelectedNode(null)
              }
            }}
          >
            {/* Enhanced Grid Background */}
            <div className="absolute inset-0 opacity-30 pointer-events-none">
              <svg width="100%" height="100%">
                <defs>
                  <pattern id="enhanced-grid" width="30" height="30" patternUnits="userSpaceOnUse">
                    <path d="M 30 0 L 0 0 0 30" fill="none" stroke="#e2e8f0" strokeWidth="1"/>
                    <circle cx="0" cy="0" r="1" fill="#cbd5e1" opacity="0.5"/>
                  </pattern>
                  <radialGradient id="grid-fade" cx="50%" cy="50%" r="50%">
                    <stop offset="0%" stopColor="white" stopOpacity="0"/>
                    <stop offset="100%" stopColor="white" stopOpacity="0.3"/>
                  </radialGradient>
                </defs>
                <rect width="100%" height="100%" fill="url(#enhanced-grid)" />
                <rect width="100%" height="100%" fill="url(#grid-fade)" />
              </svg>
            </div>

            {/* Enhanced Connections */}
            <svg className="absolute inset-0 w-full h-full pointer-events-none">
              <defs>
                <filter id="connection-glow" x="-50%" y="-50%" width="200%" height="200%">
                  <feMorphology operator="dilate" radius="1"/>
                  <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                  <feMerge> 
                    <feMergeNode in="coloredBlur"/>
                    <feMergeNode in="SourceGraphic"/> 
                  </feMerge>
                </filter>
                <linearGradient id="connection-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stopColor="currentColor" stopOpacity="0.8"/>
                  <stop offset="50%" stopColor="currentColor" stopOpacity="1"/>
                  <stop offset="100%" stopColor="currentColor" stopOpacity="0.8"/>
                </linearGradient>
                {/* Arrow marker */}
                <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                  refX="9" refY="3.5" orient="auto">
                  <polygon points="0 0, 10 3.5, 0 7" fill="currentColor" />
                </marker>
              </defs>
              {connections.map(connection => {
                const fromNode = nodes.find(n => n.id === connection.fromNodeId)
                const toNode = nodes.find(n => n.id === connection.toNodeId)
                if (!fromNode || !toNode) return null
                
                // Calculate connection points at edge of nodes
                const fromCenterX = fromNode.x + fromNode.width / 2
                const fromCenterY = fromNode.y + fromNode.height / 2
                const toCenterX = toNode.x + toNode.width / 2
                const toCenterY = toNode.y + toNode.height / 2
                
                // Calculate edge points for cleaner connections
                const dx = toCenterX - fromCenterX
                const dy = toCenterY - fromCenterY
                const distance = Math.sqrt(dx * dx + dy * dy)
                
                // Offset from center to edge of node
                const fromOffset = 75 // Half of node width/height
                const toOffset = 75
                
                const fromX = fromCenterX + (dx / distance) * fromOffset
                const fromY = fromCenterY + (dy / distance) * fromOffset
                const toX = toCenterX - (dx / distance) * toOffset
                const toY = toCenterY - (dy / distance) * toOffset
                
                // Create curved path similar to Campfire
                const midX = (fromX + toX) / 2
                const midY = (fromY + toY) / 2
                
                // Control points for curve - adjust curve based on distance and direction
                const curveFactor = Math.min(distance / 4, 100)
                const controlX1 = fromX + (dx / distance) * curveFactor * 0.5
                const controlY1 = fromY + (dy / distance) * curveFactor * 0.5
                const controlX2 = toX - (dx / distance) * curveFactor * 0.5
                const controlY2 = toY - (dy / distance) * curveFactor * 0.5
                
                // Create smooth curved path
                const pathData = `M ${fromX} ${fromY} C ${controlX1} ${controlY1}, ${controlX2} ${controlY2}, ${toX} ${toY}`
                
                return (
                  <g key={connection.id}>
                    {/* Background stroke for better visibility */}
                    <path
                      d={pathData}
                      stroke="#ffffff"
                      strokeWidth={(connection.strokeWidth || 3) + 3}
                      fill="none"
                      className="opacity-80"
                      strokeDasharray={connection.strokeDasharray || undefined}
                    />
                    {/* Main Connection Line with Curve */}
                    <path
                      d={pathData}
                      stroke={connection.color || '#3b82f6'}
                      strokeWidth={connection.strokeWidth || 3}
                      fill="none"
                      filter="url(#connection-glow)"
                      markerEnd={connection.hasArrow ? "url(#arrowhead)" : undefined}
                      className="pointer-events-auto cursor-pointer hover:opacity-80 transition-all duration-200"
                      onClick={() => setSelectedConnection && setSelectedConnection(connection.id)}
                      style={{ color: connection.color || '#3b82f6' }}
                      strokeDasharray={connection.strokeDasharray || undefined}
                    />
                    {/* Connection Label */}
                    {connection.label && (
                      <g>
                        <rect
                          x={midX - (connection.label.length * 4)}
                          y={midY - 12}
                          width={connection.label.length * 8}
                          height={24}
                          rx="12"
                          fill="white"
                          stroke={connection.color || '#3b82f6'}
                          strokeWidth="1.5"
                          className="opacity-95"
                        />
                        <text
                          x={midX}
                          y={midY + 4}
                          textAnchor="middle"
                          className="text-xs font-medium select-none pointer-events-none"
                          style={{ 
                            fontSize: '11px',
                            fill: connection.textColor || '#374151'
                          }}
                        >
                          {connection.label}
                        </text>
                      </g>
                    )}
                  </g>
                )
              })}
            </svg>

            {/* Enhanced Character Nodes */}
            {nodes.map(node => (
              <div
                key={node.id}
                data-node-id={node.id}
                className={cn(
                  "absolute bg-gradient-to-br from-white via-white to-gray-50 rounded-2xl shadow-lg border-2 cursor-move select-none group transition-all duration-200",
                  selectedNode === node.id 
                    ? "border-blue-400 shadow-blue-200/50 shadow-xl scale-105" 
                    : "border-gray-200/80 hover:border-blue-300 hover:shadow-xl hover:scale-102",
                  "backdrop-blur-sm"
                )}
                style={{
                  left: node.x,
                  top: node.y,
                  width: node.width,
                  height: node.height
                }}
                onMouseDown={(e) => handleNodeMouseDown(node.id, e)}
                onClick={() => {
                  if (isConnecting) {
                    completeConnection(node.id)
                  } else {
                    setSelectedNode(node.id)
                  }
                }}
              >
                {/* Card Background with Gradient Overlay */}
                <div className="absolute inset-0 bg-gradient-to-br from-blue-50/30 via-transparent to-indigo-50/30 rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-200" />
                
                <div className="relative p-4 h-full flex items-center justify-center">
                  <div className="text-center">
                    {/* Enhanced Avatar */}
                    <div className="relative w-12 h-12 mx-auto mb-3">
                      <div className="w-full h-full bg-gradient-to-br from-blue-100 via-indigo-100 to-purple-100 rounded-full flex items-center justify-center text-lg font-bold text-blue-700 shadow-md group-hover:shadow-lg transition-shadow">
                        {node.name.charAt(0).toUpperCase()}
                      </div>
                      {/* Avatar Ring */}
                      <div className="absolute inset-0 rounded-full border-2 border-white shadow-sm group-hover:border-blue-200 transition-colors" />
                      {/* Pulse Effect for Selected */}
                      {selectedNode === node.id && (
                        <div className="absolute inset-0 rounded-full border-2 border-blue-400 animate-pulse" />
                      )}
                    </div>
                    
                    {/* Enhanced Name */}
                    <div className="mb-1">
                      <span className="text-sm font-semibold text-gray-900 block leading-tight">
                        {node.name}
                      </span>
                    </div>
                    
                    {/* Enhanced Type Badge */}
                    <div className="inline-flex items-center px-2 py-1 rounded-full bg-gradient-to-r from-blue-100 to-indigo-100 text-xs font-medium text-blue-700 border border-blue-200/50">
                      <UserCircle className="w-3 h-3 mr-1" />
                      {node.type}
                    </div>
                  </div>
                </div>

                {/* Enhanced Node Actions */}
                {selectedNode === node.id && (
                  <div className="absolute -top-4 -right-4 flex gap-1 z-50">
                    <Button
                      size="sm"
                      className="w-10 h-10 p-0 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white border-2 border-white shadow-lg hover:shadow-xl transition-all duration-200 rounded-full"
                      onClick={(e) => {
                        e.stopPropagation()
                        e.preventDefault()
                        startConnection(node.id)
                      }}
                      title="Create Connection"
                    >
                      <Link2 className="w-4 h-4" />
                    </Button>
                    <Button
                      size="sm"
                      className="w-10 h-10 p-0 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white border-2 border-white shadow-lg hover:shadow-xl transition-all duration-200 rounded-full"
                      onClick={(e) => {
                        e.stopPropagation()
                        e.preventDefault()
                        
                        // Remove the node from the nodes array
                        setNodes(prev => {
                          const filtered = prev.filter(n => n.id !== node.id)
                          return filtered
                        })
                        
                        // Remove all connections involving this node
                        setConnections(prev => {
                          const filtered = prev.filter(c => c.fromNodeId !== node.id && c.toNodeId !== node.id)
                          return filtered
                        })
                        
                        // Clear selection
                        // setSelectedNode(null) // Commented out to preserve node selection
                      }}
                      title="Delete Node"
                    >
                      <Trash2 className="w-4 h-4" />
                    </Button>
                  </div>
                )}

                {/* Connection Indicator */}
                {isConnecting && connectionStart && (
                  <div className="absolute inset-0 rounded-2xl border-2 border-dashed border-blue-400 bg-blue-50/50 animate-pulse" />
                )}
              </div>
            ))}

            {/* Enhanced Connection Guide */}
            {isConnecting && (
              <div className="absolute top-6 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-blue-100 to-indigo-100 text-blue-800 px-6 py-3 rounded-2xl shadow-lg text-sm font-medium border border-blue-200/50 backdrop-blur-sm">
                <div className="flex items-center">
                  <div className="w-3 h-3 bg-blue-500 rounded-full animate-pulse mr-3" />
                  Click on another character to create a connection
                </div>
              </div>
            )}
          </div>
        </div>

        {/* Enhanced Connection Properties Panel */}
        {selectedConnection && (
          <div className="absolute bottom-6 right-6 w-80 bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl border border-gray-200/60 p-5 animate-in slide-in-from-bottom-2 max-h-[80vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-5">
              <h4 className="font-bold text-gray-900 flex items-center text-lg">
                <Settings className="w-5 h-5 mr-2 text-indigo-600" />
                Connection Editor
              </h4>
              <Button
                size="sm"
                variant="ghost"
                onClick={() => setSelectedConnection(null)}
                className="w-8 h-8 p-0 text-gray-400 hover:text-gray-600 hover:bg-gray-100"
              >
                <X className="w-4 h-4" />
              </Button>
            </div>
            
            <div className="space-y-5">
              {/* Relationship Type - Single unified field */}
              <div>
                <Label className="text-sm font-semibold text-gray-800 mb-3 block flex items-center">
                  <Network className="w-4 h-4 mr-2 text-gray-600" />
                  Relationship Type
                </Label>
                <Select
                  value={connections.find(c => c.id === selectedConnection)?.type || 'friendship'}
                  onValueChange={(value) => {
                    setConnections(prev => prev.map(conn => 
                      conn.id === selectedConnection 
                        ? { ...conn, type: value, label: value === 'custom' ? conn.label || '' : value }
                        : conn
                    ))
                  }}
                >
                  <SelectTrigger className="w-full">
                    <SelectValue placeholder="Select relationship type" />
                  </SelectTrigger>
                  <SelectContent className="bg-white border-2 border-gray-200 shadow-lg rounded-lg backdrop-blur-sm z-50">
                    <SelectItem value="friendship" className="hover:bg-gray-50 focus:bg-gray-50 cursor-pointer">🤝 Friendship</SelectItem>
                    <SelectItem value="romance" className="hover:bg-gray-50 focus:bg-gray-50 cursor-pointer">💕 Romance</SelectItem>
                    <SelectItem value="family" className="hover:bg-gray-50 focus:bg-gray-50 cursor-pointer">👨‍👩‍👧‍👦 Family</SelectItem>
                    <SelectItem value="rivalry" className="hover:bg-gray-50 focus:bg-gray-50 cursor-pointer">⚔️ Rivalry</SelectItem>
                    <SelectItem value="mentor" className="hover:bg-gray-50 focus:bg-gray-50 cursor-pointer">🧑‍🏫 Mentor</SelectItem>
                    <SelectItem value="alliance" className="hover:bg-gray-50 focus:bg-gray-50 cursor-pointer">🤝 Alliance</SelectItem>
                    <SelectItem value="enemy" className="hover:bg-gray-50 focus:bg-gray-50 cursor-pointer">😡 Enemy</SelectItem>
                    <SelectItem value="professional" className="hover:bg-gray-50 focus:bg-gray-50 cursor-pointer">💼 Professional</SelectItem>
                    <SelectItem value="neutral" className="hover:bg-gray-50 focus:bg-gray-50 cursor-pointer">😐 Neutral</SelectItem>
                    <SelectItem value="custom" className="hover:bg-gray-50 focus:bg-gray-50 cursor-pointer">✏️ Custom</SelectItem>
                  </SelectContent>
                </Select>
                
                {/* Custom relationship input */}
                {connections.find(c => c.id === selectedConnection)?.type === 'custom' && (
                  <div className="mt-3">
                    <Label className="text-xs font-medium text-gray-700 mb-2 block">Custom Relationship</Label>
                    <Input
                      value={connections.find(c => c.id === selectedConnection)?.label || ''}
                      onChange={(e) => {
                        setConnections(prev => prev.map(conn => 
                          conn.id === selectedConnection 
                            ? { ...conn, label: e.target.value }
                            : conn
                        ))
                      }}
                      className="text-sm bg-white border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
                      placeholder="Enter custom relationship (e.g. 'Business Partner', 'Childhood Friend')"
                    />
                  </div>
                )}
              </div>

              {/* Enhanced Arrow Configuration */}
              <div>
                <Label className="text-sm font-semibold text-gray-800 mb-3 block flex items-center">
                  <ArrowRight className="w-4 h-4 mr-2 text-gray-600" />
                  Arrow Configuration
                </Label>
                <div className="space-y-4">
                  {/* Arrow Direction */}
                  <div>
                    <Label className="text-xs font-medium text-gray-700 mb-2 block">Direction</Label>
                    <div className="grid grid-cols-3 gap-2">
                      <button
                        onClick={() => {
                          setConnections(prev => prev.map(conn => 
                            conn.id === selectedConnection 
                              ? { ...conn, hasArrow: false, hasReverseArrow: false }
                              : conn
                          ))
                        }}
                        className={`p-3 rounded-lg border text-xs font-medium transition-colors flex items-center justify-center ${
                          !connections.find(c => c.id === selectedConnection)?.hasArrow && !connections.find(c => c.id === selectedConnection)?.hasReverseArrow
                            ? 'border-indigo-500 bg-indigo-50 text-indigo-700'
                            : 'border-gray-200 hover:border-gray-300 text-gray-700'
                        }`}
                      >
                        <div className="w-8 h-0.5 bg-current"></div>
                      </button>
                      <button
                        onClick={() => {
                          setConnections(prev => prev.map(conn => 
                            conn.id === selectedConnection 
                              ? { ...conn, hasArrow: true, hasReverseArrow: false }
                              : conn
                          ))
                        }}
                        className={`p-3 rounded-lg border text-xs font-medium transition-colors flex items-center justify-center ${
                          connections.find(c => c.id === selectedConnection)?.hasArrow && !connections.find(c => c.id === selectedConnection)?.hasReverseArrow
                            ? 'border-indigo-500 bg-indigo-50 text-indigo-700'
                            : 'border-gray-200 hover:border-gray-300 text-gray-700'
                        }`}
                      >
                        <div className="w-6 h-0.5 bg-current mr-1"></div>
                        <div className="w-0 h-0 border-l-2 border-l-current border-y-2 border-y-transparent"></div>
                      </button>
                      <button
                        onClick={() => {
                          setConnections(prev => prev.map(conn => 
                            conn.id === selectedConnection 
                              ? { 
                                  ...conn, 
                                  hasArrow: true, 
                                  hasReverseArrow: true,
                                  arrowSize: conn.arrowSize || 12,
                                  reverseArrowSize: conn.reverseArrowSize || 12,
                                  arrowColor: conn.arrowColor || conn.color,
                                  reverseArrowColor: conn.reverseArrowColor || conn.color
                                }
                              : conn
                          ))
                        }}
                        className={`p-3 rounded-lg border text-xs font-medium transition-colors flex items-center justify-center ${
                          connections.find(c => c.id === selectedConnection)?.hasArrow && connections.find(c => c.id === selectedConnection)?.hasReverseArrow
                            ? 'border-indigo-500 bg-indigo-50 text-indigo-700'
                            : 'border-gray-200 hover:border-gray-300 text-gray-700'
                        }`}
                      >
                        <div className="w-0 h-0 border-r-2 border-r-current border-y-2 border-y-transparent"></div>
                        <div className="w-4 h-0.5 bg-current mx-1"></div>
                        <div className="w-0 h-0 border-l-2 border-l-current border-y-2 border-y-transparent"></div>
                      </button>
                    </div>
                    <div className="grid grid-cols-3 gap-2 text-xs text-gray-600 mt-1">
                      <span className="text-center">None</span>
                      <span className="text-center">Forward</span>
                      <span className="text-center">Both</span>
                    </div>
                  </div>
                  
                  {/* Forward Arrow Settings */}
                  {connections.find(c => c.id === selectedConnection)?.hasArrow && (
                    <div className="bg-blue-50 rounded-lg p-3 border border-blue-200">
                      <h4 className="text-sm font-semibold text-blue-800 mb-3 flex items-center">
                        <ArrowRight className="w-4 h-4 mr-2" />
                        Forward Arrow
                      </h4>
                      <div className="space-y-3">
                        <div>
                          <Label className="text-xs font-medium text-gray-700 mb-2 block">Size</Label>
                          <input
                            type="range"
                            min="6"
                            max="24"
                            value={connections.find(c => c.id === selectedConnection)?.arrowSize || 12}
                            onChange={(e) => {
                              setConnections(prev => prev.map(conn => 
                                conn.id === selectedConnection 
                                  ? { ...conn, arrowSize: parseInt(e.target.value) }
                                  : conn
                              ))
                            }}
                            className="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer"
                          />
                          <div className="flex justify-between text-xs text-gray-500 mt-1">
                            <span>Small</span>
                            <span>Large</span>
                          </div>
                        </div>
                        <div>
                          <Label className="text-xs font-medium text-gray-700 mb-2 block">Color</Label>
                          <div className="flex items-center gap-2">
                            <input
                              type="color"
                              value={connections.find(c => c.id === selectedConnection)?.arrowColor || connections.find(c => c.id === selectedConnection)?.color || '#3b82f6'}
                              onChange={(e) => {
                                setConnections(prev => prev.map(conn => 
                                  conn.id === selectedConnection 
                                    ? { ...conn, arrowColor: e.target.value }
                                    : conn
                                ))
                              }}
                              className="w-8 h-8 rounded border-2 border-gray-200 cursor-pointer"
                            />
                            <div className="flex gap-1">
                              {['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'].map(color => (
                                <button
                                  key={color}
                                  onClick={() => {
                                    setConnections(prev => prev.map(conn => 
                                      conn.id === selectedConnection 
                                        ? { ...conn, arrowColor: color }
                                        : conn
                                    ))
                                  }}
                                  className="w-6 h-6 rounded border-2 border-white shadow-sm hover:scale-110 transition-transform"
                                  style={{ backgroundColor: color }}
                                />
                              ))}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Reverse Arrow Settings */}
                  {connections.find(c => c.id === selectedConnection)?.hasReverseArrow && (
                    <div className="bg-purple-50 rounded-lg p-3 border border-purple-200">
                      <h4 className="text-sm font-semibold text-purple-800 mb-3 flex items-center">
                        <ArrowRight className="w-4 h-4 mr-2 rotate-180" />
                        Reverse Arrow
                      </h4>
                      <div className="space-y-3">
                        <div>
                          <Label className="text-xs font-medium text-gray-700 mb-2 block">Size</Label>
                          <input
                            type="range"
                            min="6"
                            max="24"
                            value={connections.find(c => c.id === selectedConnection)?.reverseArrowSize || 12}
                            onChange={(e) => {
                              setConnections(prev => prev.map(conn => 
                                conn.id === selectedConnection 
                                  ? { ...conn, reverseArrowSize: parseInt(e.target.value) }
                                  : conn
                              ))
                            }}
                            className="w-full h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer"
                          />
                          <div className="flex justify-between text-xs text-gray-500 mt-1">
                            <span>Small</span>
                            <span>Large</span>
                          </div>
                        </div>
                        <div>
                          <Label className="text-xs font-medium text-gray-700 mb-2 block">Color</Label>
                          <div className="flex items-center gap-2">
                            <input
                              type="color"
                              value={connections.find(c => c.id === selectedConnection)?.reverseArrowColor || connections.find(c => c.id === selectedConnection)?.color || '#3b82f6'}
                              onChange={(e) => {
                                setConnections(prev => prev.map(conn => 
                                  conn.id === selectedConnection 
                                    ? { ...conn, reverseArrowColor: e.target.value }
                                    : conn
                                ))
                              }}
                              className="w-8 h-8 rounded border-2 border-gray-200 cursor-pointer"
                            />
                            <div className="flex gap-1">
                              {['#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#ec4899'].map(color => (
                                <button
                                  key={color}
                                  onClick={() => {
                                    setConnections(prev => prev.map(conn => 
                                      conn.id === selectedConnection 
                                        ? { ...conn, reverseArrowColor: color }
                                        : conn
                                    ))
                                  }}
                                  className="w-6 h-6 rounded border-2 border-white shadow-sm hover:scale-110 transition-transform"
                                  style={{ backgroundColor: color }}
                                />
                              ))}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
              
              {/* Connection Colors */}
              <div>
                <Label className="text-sm font-semibold text-gray-800 mb-3 block flex items-center">
                  <Palette className="w-4 h-4 mr-2 text-gray-600" />
                  Colors & Style
                </Label>
                <div className="space-y-4">
                  {/* Line Color */}
                  <div>
                    <Label className="text-xs font-medium text-gray-700 mb-2 block">Line Color</Label>
                    <div className="flex items-center gap-3">
                      <input
                        type="color"
                        value={connections.find(c => c.id === selectedConnection)?.color || '#3b82f6'}
                        onChange={(e) => {
                          setConnections(prev => prev.map(conn => 
                            conn.id === selectedConnection 
                              ? { ...conn, color: e.target.value }
                              : conn
                          ))
                        }}
                        className="w-12 h-12 rounded-xl border-2 border-gray-200 cursor-pointer"
                      />
                      <div className="flex flex-wrap gap-1">
                        {[
                          '#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899',
                          '#64748b', '#dc2626', '#ea580c', '#65a30d', '#0891b2', '#7c3aed'
                        ].map(color => (
                          <button
                            key={color}
                            onClick={() => {
                              setConnections(prev => prev.map(conn => 
                                conn.id === selectedConnection 
                                  ? { ...conn, color }
                                  : conn
                              ))
                            }}
                            className="w-7 h-7 rounded-lg border-2 border-white shadow-sm hover:scale-110 transition-transform"
                            style={{ backgroundColor: color }}
                          />
                        ))}
                      </div>
                    </div>
                  </div>
                  
                  {/* Text Color */}
                  <div>
                    <Label className="text-xs font-medium text-gray-700 mb-2 block">Text Color</Label>
                    <div className="flex items-center gap-3">
                      <input
                        type="color"
                        value={connections.find(c => c.id === selectedConnection)?.textColor || '#374151'}
                        onChange={(e) => {
                          setConnections(prev => prev.map(conn => 
                            conn.id === selectedConnection 
                              ? { ...conn, textColor: e.target.value }
                              : conn
                          ))
                        }}
                        className="w-12 h-12 rounded-xl border-2 border-gray-200 cursor-pointer"
                      />
                      <div className="flex flex-wrap gap-1">
                        {[
                          '#374151', '#111827', '#ffffff', '#ef4444', '#f59e0b', '#10b981',
                          '#3b82f6', '#8b5cf6', '#ec4899', '#64748b', '#dc2626', '#7c3aed'
                        ].map(color => (
                          <button
                            key={color}
                            onClick={() => {
                              setConnections(prev => prev.map(conn => 
                                conn.id === selectedConnection 
                                  ? { ...conn, textColor: color }
                                  : conn
                              ))
                            }}
                            className="w-7 h-7 rounded-lg border-2 border-white shadow-sm hover:scale-110 transition-transform"
                            style={{ backgroundColor: color }}
                          />
                        ))}
                      </div>
                    </div>
                  </div>

                  {/* Line Thickness */}
                  <div>
                    <Label className="text-xs font-medium text-gray-700 mb-2 block">Line Thickness</Label>
                    <input
                      type="range"
                      min="1"
                      max="8"
                      value={connections.find(c => c.id === selectedConnection)?.strokeWidth || 3}
                      onChange={(e) => {
                        setConnections(prev => prev.map(conn => 
                          conn.id === selectedConnection 
                            ? { ...conn, strokeWidth: parseInt(e.target.value) }
                            : conn
                        ))
                      }}
                      className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                    />
                    <div className="flex justify-between text-xs text-gray-500 mt-1">
                      <span>Thin</span>
                      <span>Thick</span>
                    </div>
                  </div>

                  {/* Line Style */}
                  <div>
                    <Label className="text-xs font-medium text-gray-700 mb-2 block">Line Style</Label>
                    <div className="grid grid-cols-2 gap-2">
                      {[
                        { value: 'solid', label: 'Solid', pattern: null },
                        { value: 'dashed', label: 'Dashed', pattern: '8,4' },
                        { value: 'dotted', label: 'Dotted', pattern: '2,2' },
                        { value: 'dashdot', label: 'Dash-Dot', pattern: '8,2,2,2' }
                      ].map(style => (
                        <button
                          key={style.value}
                          onClick={() => {
                            setConnections(prev => prev.map(conn => 
                              conn.id === selectedConnection 
                                ? { ...conn, strokeDasharray: style.pattern }
                                : conn
                            ))
                          }}
                          className={`p-2 rounded-lg border text-xs font-medium transition-colors ${
                            connections.find(c => c.id === selectedConnection)?.strokeDasharray === style.pattern
                              ? 'border-indigo-500 bg-indigo-50 text-indigo-700'
                              : 'border-gray-200 hover:border-gray-300 text-gray-700'
                          }`}
                        >
                          {style.label}
                        </button>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
              
              {/* Action Buttons */}
              <div className="flex justify-between pt-4 border-t border-gray-200">
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => {
                    setConnections(prev => prev.filter(c => c.id !== selectedConnection))
                    setSelectedConnection(null)
                  }}
                  className="text-red-600 border-red-200 hover:bg-red-50 hover:border-red-300 text-sm px-4 py-2"
                >
                  <Trash2 className="w-4 h-4 mr-2" />
                  Delete
                </Button>
                <Button
                  size="sm"
                  onClick={() => setSelectedConnection(null)}
                  className="bg-gradient-to-r from-indigo-500 to-blue-600 hover:from-indigo-600 hover:to-blue-700 text-white text-sm px-4 py-2"
                >
                  <CheckCircle className="w-4 h-4 mr-2" />
                  Done
                </Button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}
e x p o r t   d e f a u l t   R e l a t i o n s h i p s P a n e l  
 